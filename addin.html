<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fleet Dashboard</title>
</head>
<body>
<style>
  html,body{margin:0;padding:0;background:#0b0f1a;color:#e2e8f0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;min-height:100vh;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,229,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
  *{box-sizing:border-box;}
  #app{position:relative;z-index:1;max-width:1280px;margin:0 auto;padding:28px 24px;}
  .hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:16px;}
  h1{font-size:1.8rem;font-weight:800;letter-spacing:-0.03em;background:linear-gradient(90deg,#00e5ff,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  #dateRange{font-size:0.82rem;color:#64748b;margin-top:4px;font-family:'Courier New',monospace;}
  .hdr-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}

  /* DATE RANGE PILLS */
  .range-group{display:flex;gap:6px;background:#121929;border:1px solid #1e2e4a;border-radius:10px;padding:4px;}
  .range-btn{background:transparent;border:none;color:#64748b;padding:6px 14px;border-radius:7px;cursor:pointer;font-family:'Courier New',monospace;font-size:0.72rem;letter-spacing:0.05em;transition:all 0.2s;}
  .range-btn:hover{color:#e2e8f0;}
  .range-btn.active{background:#1a2540;color:#00e5ff;border:1px solid rgba(0,229,255,0.25);}

  .btn{background:#1a2540;border:1px solid #1e2e4a;color:#e2e8f0;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:0.82rem;transition:all 0.2s;display:flex;align-items:center;gap:6px;white-space:nowrap;}
  .btn:hover{border-color:#00e5ff;color:#00e5ff;}
  .btn svg{width:14px;height:14px;flex-shrink:0;}

  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:28px;}
  .kpi{background:#121929;border:1px solid #1e2e4a;border-radius:14px;padding:22px;position:relative;overflow:hidden;}
  .kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
  .kpi.b::before{background:#00e5ff;}.kpi.o::before{background:#ff6b35;}.kpi.p::before{background:#a78bfa;}.kpi.g::before{background:#10b981;}.kpi.t::before{background:#f59e0b;}
  .kpi-lbl{font-size:0.7rem;color:#64748b;text-transform:uppercase;letter-spacing:0.1em;font-family:'Courier New',monospace;margin-bottom:10px;}
  .kpi-val{font-size:1.9rem;font-weight:800;line-height:1;}
  .kpi.b .kpi-val{color:#00e5ff;}.kpi.o .kpi-val{color:#ff6b35;}.kpi.p .kpi-val{color:#a78bfa;}.kpi.g .kpi-val{color:#10b981;}.kpi.t .kpi-val{color:#f59e0b;}
  .kpi-sub{font-size:0.78rem;color:#64748b;margin-top:6px;}

  .sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px;}
  .sec-ttl{font-size:1rem;font-weight:700;}
  .sec-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .srch{background:#121929;border:1px solid #1e2e4a;border-radius:8px;padding:8px 14px;color:#e2e8f0;font-size:0.875rem;width:200px;outline:none;transition:border-color 0.2s;}
  .srch:focus{border-color:#00e5ff;}.srch::placeholder{color:#64748b;}

  .tbl-wrap{background:#121929;border:1px solid #1e2e4a;border-radius:14px;overflow:hidden;margin-bottom:20px;}
  table{width:100%;border-collapse:collapse;}
  thead tr{background:#1a2540;border-bottom:1px solid #1e2e4a;}
  th{font-family:'Courier New',monospace;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;color:#64748b;padding:13px 18px;text-align:left;cursor:pointer;user-select:none;white-space:nowrap;}
  th:hover{color:#00e5ff;}
  th.sort-asc::after{content:' ↑';color:#00e5ff;}
  th.sort-desc::after{content:' ↓';color:#00e5ff;}
  tbody tr{border-bottom:1px solid #1e2e4a;transition:background 0.15s;}
  tbody tr:last-child{border-bottom:none;}tbody tr:hover{background:#1a2540;}
  td{padding:13px 18px;font-size:0.88rem;}
  .vname{font-family:'Courier New',monospace;font-size:0.82rem;color:#00e5ff;font-weight:500;}
  .mval{font-family:'Courier New',monospace;font-weight:500;}
  .tval{font-family:'Courier New',monospace;color:#94a3b8;}
  .ibar-wrap{display:flex;align-items:center;gap:10px;}
  .ibar-bg{flex:1;height:6px;background:#1e2e4a;border-radius:99px;overflow:hidden;min-width:60px;}
  .ibar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,#ff6b35,#ff9a5c);}
  .ival{font-family:'Courier New',monospace;font-size:0.82rem;min-width:50px;text-align:right;}
  .bdg{display:inline-block;padding:3px 10px;border-radius:99px;font-size:0.7rem;font-family:'Courier New',monospace;}
  .bh{background:rgba(239,68,68,0.15);color:#f87171;border:1px solid rgba(239,68,68,0.25);}
  .bm{background:rgba(245,158,11,0.15);color:#fbbf24;border:1px solid rgba(245,158,11,0.25);}
  .bl{background:rgba(16,185,129,0.15);color:#34d399;border:1px solid rgba(16,185,129,0.25);}

  .box{padding:40px 24px;text-align:center;}
  .spinner{width:34px;height:34px;border:3px solid #1e2e4a;border-top-color:#00e5ff;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px;}
  .pbar-bg{background:#1e2e4a;border-radius:99px;height:8px;overflow:hidden;max-width:400px;margin:12px auto 0;}
  .pbar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,#00e5ff,#a78bfa);transition:width 0.3s ease;}
  .msg{font-family:'Courier New',monospace;font-size:0.78rem;color:#64748b;margin-top:8px;}
  .err-box{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:10px;padding:16px 20px;margin:0 0 16px;font-family:'Courier New',monospace;font-size:0.75rem;color:#f87171;word-break:break-all;}
  .foot{font-family:'Courier New',monospace;font-size:0.7rem;color:#64748b;text-align:center;padding-top:4px;}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>

<div id="app">
  <div class="hdr">
    <div><h1>Fleet Dashboard</h1><p id="dateRange"></p></div>
    <div class="hdr-right">
      <div class="range-group">
        <button class="range-btn" onclick="fleetDash.setRange(7)">7D</button>
        <button class="range-btn active" onclick="fleetDash.setRange(30)">30D</button>
        <button class="range-btn" onclick="fleetDash.setRange(60)">60D</button>
        <button class="range-btn" onclick="fleetDash.setRange(90)">90D</button>
      </div>
      <button class="btn" id="btnRefresh">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        Refresh
      </button>
    </div>
  </div>

  <div class="kpis">
    <div class="kpi b"><div class="kpi-lbl">Total Fleet Mileage</div><div class="kpi-val" id="k1">—</div><div class="kpi-sub">miles in selected period</div></div>
    <div class="kpi o"><div class="kpi-lbl">Total Idle Time</div><div class="kpi-val" id="k2">—</div><div class="kpi-sub">hours across all vehicles</div></div>
    <div class="kpi p"><div class="kpi-lbl">Avg Mileage / Vehicle</div><div class="kpi-val" id="k3">—</div><div class="kpi-sub">miles per vehicle</div></div>
    <div class="kpi g"><div class="kpi-lbl">Vehicles Tracked</div><div class="kpi-val" id="k4">—</div><div class="kpi-sub">active in period</div></div>
    <div class="kpi t"><div class="kpi-lbl">Total Trips</div><div class="kpi-val" id="k5">—</div><div class="kpi-sub">across all vehicles</div></div>
  </div>

  <div class="sec-hdr">
    <span class="sec-ttl">Vehicle Breakdown</span>
    <div class="sec-right">
      <input type="text" class="srch" id="srch" placeholder="Search vehicle..." oninput="fleetDash.filter()"/>
      <button class="btn" onclick="fleetDash.exportCSV()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Export CSV
      </button>
    </div>
  </div>

  <div id="errBox"></div>
  <div class="tbl-wrap"><div id="tbl"><div class="box"><div class="spinner"></div><div class="msg">WAITING FOR GEOTAB...</div></div></div></div>
  <div class="foot" id="foot"></div>
</div>

<script>
var fleetDash = (function() {
  var _api      = null;
  var _rows     = [];
  var _days     = 30;
  var _sortKey  = 'miles';
  var _sortDir  = -1; // -1 = desc, 1 = asc

  function setDateRange() {
    var now = new Date(), from = new Date(now);
    from.setDate(from.getDate() - _days);
    var fmt = function(d){return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});};
    document.getElementById('dateRange').textContent = fmt(from) + ' \u2192 ' + fmt(now);
  }

  function showErr(msg) {
    document.getElementById('errBox').innerHTML = '<div class="err-box">&#9888; ' + msg + '</div>';
  }
  function clearErr() { document.getElementById('errBox').innerHTML = ''; }

  function showBox(label, pct) {
    document.getElementById('tbl').innerHTML =
      '<div class="box"><div class="spinner"></div>' +
      '<div class="msg">' + label + '</div>' +
      (pct !== undefined ? '<div class="pbar-bg"><div class="pbar-fill" style="width:'+pct+'%"></div></div>' : '') +
      '</div>';
  }

  function resetKPIs() {
    ['k1','k2','k3','k4','k5'].forEach(function(id){document.getElementById(id).textContent='—';});
  }

  function renderKPIs(rows) {
    var tm = rows.reduce(function(s,r){return s+r.miles;},0);
    var ti = rows.reduce(function(s,r){return s+r.idleH;},0);
    var tt = rows.reduce(function(s,r){return s+r.trips;},0);
    document.getElementById('k1').textContent = Math.round(tm).toLocaleString();
    document.getElementById('k2').textContent = ti.toFixed(1)+'h';
    document.getElementById('k3').textContent = rows.length ? Math.round(tm/rows.length).toLocaleString() : '0';
    document.getElementById('k4').textContent = rows.length;
    document.getElementById('k5').textContent = tt.toLocaleString();
    document.getElementById('foot').textContent = 'Last refreshed: ' + new Date().toLocaleString() + '  |  Last ' + _days + ' days';
  }

  function renderTable(rows) {
    if (!rows||!rows.length){showBox('No data found for the selected period.');return;}
    var mx = Math.max.apply(null, rows.map(function(r){return r.idleH||0;})) || 1;

    // Build header with sort indicators
    function thCls(k) {
      if (_sortKey !== k) return '';
      return _sortDir === -1 ? ' class="sort-desc"' : ' class="sort-asc"';
    }

    var h = '<table><thead><tr>'+
      '<th onclick="fleetDash.sort(\'name\');"'+thCls('name')+'>Vehicle</th>'+
      '<th onclick="fleetDash.sort(\'miles\');"'+thCls('miles')+'>Mileage (mi)</th>'+
      '<th onclick="fleetDash.sort(\'trips\');"'+thCls('trips')+'>Trips</th>'+
      '<th onclick="fleetDash.sort(\'idleH\');"'+thCls('idleH')+'>Idle Time</th>'+
      '<th>Idle Level</th>'+
      '</tr></thead><tbody>';

    rows.forEach(function(r){
      var idleH = r.idleH || 0;
      var pct   = (idleH / mx) * 100;
      var lbl   = pct > 66 ? 'HIGH' : pct > 33 ? 'MED' : 'LOW';
      var cls   = pct > 66 ? 'bh'   : pct > 33 ? 'bm'  : 'bl';
      h += '<tr>'+
        '<td class="vname">'+r.name+'</td>'+
        '<td class="mval">'+Math.round(r.miles).toLocaleString()+'</td>'+
        '<td class="tval">'+r.trips.toLocaleString()+'</td>'+
        '<td><div class="ibar-wrap">'+
          '<div class="ibar-bg"><div class="ibar-fill" style="width:'+pct.toFixed(1)+'%"></div></div>'+
          '<span class="ival">'+idleH.toFixed(1)+'h</span>'+
        '</div></td>'+
        '<td><span class="bdg '+cls+'">'+lbl+'</span></td>'+
        '</tr>';
    });
    document.getElementById('tbl').innerHTML = h + '</tbody></table>';
  }

  function getFilteredRows() {
    var q = document.getElementById('srch').value.toLowerCase();
    return q ? _rows.filter(function(r){return r.name.toLowerCase().indexOf(q) !== -1;}) : _rows;
  }

  function kmToMiles(km) {
    var v = parseFloat(km);
    return isNaN(v) ? 0 : v * 0.621371;
  }

  // Parse Geotab duration string "HH:MM:SS.fffffff" or "D.HH:MM:SS" → hours
  function durationToHours(val) {
    if (!val) return 0;
    if (typeof val === 'number') return val / 3600;
    var s = String(val), days = 0;
    if (s.indexOf('.') !== -1 && s.indexOf(':') !== -1 && s.indexOf('.') < s.indexOf(':')) {
      var dp = s.split('.');
      days = parseInt(dp[0], 10) || 0;
      s = dp[1];
    }
    var parts = s.split(':');
    if (parts.length < 3) return 0;
    return (days * 24) + (parseInt(parts[0],10)||0) + ((parseInt(parts[1],10)||0)/60) + ((parseFloat(parts[2])||0)/3600);
  }

  function fetchData() {
    if (!_api){showBox('API not ready — please refresh.');return;}
    clearErr(); resetKPIs();
    showBox('FETCHING VEHICLES...', 5);

    var now = new Date(), from = new Date(now);
    from.setDate(from.getDate() - _days);
    var fromStr = from.toISOString(), toStr = now.toISOString();

    _api.call('Get', {typeName:'Device', resultsLimit:1000},
    function(devices) {
      if (!devices||!devices.length){showBox('No vehicles found.');return;}
      showBox('FETCHING TRIPS FOR ' + devices.length + ' VEHICLES...', 20);

      var devMap = {};
      devices.forEach(function(d){devMap[d.id] = d.name || d.id;});

      var cap   = Math.min(devices.length, 100);
      var calls = devices.slice(0, cap).map(function(d){
        return ['Get',{typeName:'Trip',search:{deviceSearch:{id:d.id},fromDate:fromStr,toDate:toStr},resultsLimit:5000}];
      });

      _api.multiCall(calls, function(results){
        var rows = [];
        devices.slice(0, cap).forEach(function(d, i){
          var trips = (results && results[i]) || [];
          var miles = 0, idleH = 0;
          trips.forEach(function(t){
            miles += kmToMiles(t.distance);
            idleH += durationToHours(t.idlingDuration);
          });
          if (miles === 0 && idleH === 0 && trips.length === 0) return;
          rows.push({name: devMap[d.id]||d.id, miles: miles, idleH: idleH, trips: trips.length});
        });

        // Apply default sort
        rows.sort(function(a,b){return b.miles - a.miles;});
        _rows    = rows;
        _sortKey = 'miles';
        _sortDir = -1;

        if (!rows.length){showBox('No trip data found for the selected period.');return;}
        renderKPIs(rows);
        renderTable(rows);
      }, function(err){
        var msg = err&&err.message ? err.message : JSON.stringify(err);
        showBox(''); showErr('Trip fetch failed: ' + msg);
      });
    },
    function(err){
      var msg = err&&err.message ? err.message : JSON.stringify(err);
      showBox(''); showErr('Failed to fetch vehicles: ' + msg);
    });
  }

  // ── PUBLIC ────────────────────────────────────────────────────────────────
  return {
    init: function(api) {
      _api = api;
      setDateRange();
      document.getElementById('btnRefresh').onclick = fetchData;
    },

    fetch: fetchData,

    setRange: function(days) {
      _days = days;
      // Update active pill
      document.querySelectorAll('.range-btn').forEach(function(btn){
        btn.classList.toggle('active', btn.textContent === days + 'D');
      });
      setDateRange();
      fetchData();
    },

    sort: function(k) {
      if (_sortKey === k) {
        _sortDir *= -1; // toggle direction
      } else {
        _sortKey = k;
        _sortDir = k === 'name' ? 1 : -1;
      }
      _rows.sort(function(a, b){
        if (typeof a[k] === 'string') return _sortDir * a[k].localeCompare(b[k]);
        return _sortDir * (b[k] - a[k]);
      });
      renderTable(getFilteredRows());
    },

    filter: function() { renderTable(getFilteredRows()); },

    exportCSV: function() {
      if (!_rows.length) return;
      var now  = new Date(), from = new Date(now);
      from.setDate(from.getDate() - _days);
      var fmt  = function(d){return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});};
      var period = fmt(from) + ' to ' + fmt(now);

      var lines = [
        'Fleet Dashboard Export',
        'Period: ' + period,
        '',
        'Vehicle,Mileage (mi),Trips,Idle Time (h),Idle Level'
      ];

      var mx = Math.max.apply(null, _rows.map(function(r){return r.idleH||0;})) || 1;
      _rows.forEach(function(r){
        var idleH = r.idleH || 0;
        var pct   = (idleH / mx) * 100;
        var lbl   = pct > 66 ? 'HIGH' : pct > 33 ? 'MED' : 'LOW';
        lines.push(
          '"' + r.name.replace(/"/g,'""') + '",' +
          Math.round(r.miles) + ',' +
          r.trips + ',' +
          idleH.toFixed(2) + ',' +
          lbl
        );
      });

      // Totals row
      var tm = _rows.reduce(function(s,r){return s+r.miles;},0);
      var tt = _rows.reduce(function(s,r){return s+r.trips;},0);
      var ti = _rows.reduce(function(s,r){return s+r.idleH;},0);
      lines.push('"TOTAL",' + Math.round(tm) + ',' + tt + ',' + ti.toFixed(2) + ',');

      var csv  = lines.join('\r\n');
      var blob = new Blob([csv], {type:'text/csv'});
      var url  = URL.createObjectURL(blob);
      var a    = document.createElement('a');
      a.href     = url;
      a.download = 'fleet-dashboard-' + _days + 'd.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  };
})();

geotab.addin = geotab.addin || {};
geotab.addin.fleetdashboard = function() {
  return {
    initialize: function(api, state, cb) {
      fleetDash.init(api);
      if (typeof cb === 'function') cb();
    },
    focus: function() { fleetDash.fetch(); },
    blur:  function() {}
  };
};
</script>
</body>
</html>
