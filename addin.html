<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fleet Dashboard</title>
</head>
<body>
<style>
  html,body{margin:0;padding:0;background:#0b0f1a;color:#e2e8f0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;min-height:100vh;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,229,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
  *{box-sizing:border-box;}
  #app{position:relative;z-index:1;max-width:1280px;margin:0 auto;padding:28px 24px;}
  .hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:16px;}
  h1{font-size:1.8rem;font-weight:800;letter-spacing:-0.03em;background:linear-gradient(90deg,#00e5ff,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  #dateRange{font-size:0.82rem;color:#64748b;margin-top:4px;font-family:'Courier New',monospace;}
  .hdr-right{display:flex;align-items:center;gap:12px;}
  .badge-30{font-family:'Courier New',monospace;font-size:0.72rem;color:#00e5ff;background:rgba(0,229,255,0.08);border:1px solid rgba(0,229,255,0.2);border-radius:6px;padding:6px 14px;}
  .btn{background:#1a2540;border:1px solid #1e2e4a;color:#e2e8f0;padding:8px 18px;border-radius:8px;cursor:pointer;font-size:0.875rem;transition:all 0.2s;}
  .btn:hover{border-color:#00e5ff;color:#00e5ff;}
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:28px;}
  .kpi{background:#121929;border:1px solid #1e2e4a;border-radius:14px;padding:22px;position:relative;overflow:hidden;}
  .kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
  .kpi.b::before{background:#00e5ff;}.kpi.o::before{background:#ff6b35;}.kpi.p::before{background:#a78bfa;}.kpi.g::before{background:#10b981;}
  .kpi-lbl{font-size:0.7rem;color:#64748b;text-transform:uppercase;letter-spacing:0.1em;font-family:'Courier New',monospace;margin-bottom:10px;}
  .kpi-val{font-size:1.9rem;font-weight:800;line-height:1;}
  .kpi.b .kpi-val{color:#00e5ff;}.kpi.o .kpi-val{color:#ff6b35;}.kpi.p .kpi-val{color:#a78bfa;}.kpi.g .kpi-val{color:#10b981;}
  .kpi-sub{font-size:0.78rem;color:#64748b;margin-top:6px;}
  .sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px;}
  .sec-ttl{font-size:1rem;font-weight:700;}
  .srch{background:#121929;border:1px solid #1e2e4a;border-radius:8px;padding:8px 14px;color:#e2e8f0;font-size:0.875rem;width:200px;outline:none;transition:border-color 0.2s;}
  .srch:focus{border-color:#00e5ff;}.srch::placeholder{color:#64748b;}
  .tbl-wrap{background:#121929;border:1px solid #1e2e4a;border-radius:14px;overflow:hidden;margin-bottom:20px;}
  table{width:100%;border-collapse:collapse;}
  thead tr{background:#1a2540;border-bottom:1px solid #1e2e4a;}
  th{font-family:'Courier New',monospace;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;color:#64748b;padding:13px 18px;text-align:left;cursor:pointer;user-select:none;white-space:nowrap;}
  th:hover{color:#00e5ff;}
  tbody tr{border-bottom:1px solid #1e2e4a;transition:background 0.15s;}
  tbody tr:last-child{border-bottom:none;}tbody tr:hover{background:#1a2540;}
  td{padding:13px 18px;font-size:0.88rem;}
  .vname{font-family:'Courier New',monospace;font-size:0.82rem;color:#00e5ff;font-weight:500;}
  .mval{font-family:'Courier New',monospace;font-weight:500;}
  .ibar-wrap{display:flex;align-items:center;gap:10px;}
  .ibar-bg{flex:1;height:6px;background:#1e2e4a;border-radius:99px;overflow:hidden;min-width:60px;}
  .ibar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,#ff6b35,#ff9a5c);}
  .ival{font-family:'Courier New',monospace;font-size:0.82rem;min-width:50px;text-align:right;}
  .bdg{display:inline-block;padding:3px 10px;border-radius:99px;font-size:0.7rem;font-family:'Courier New',monospace;}
  .bh{background:rgba(239,68,68,0.15);color:#f87171;border:1px solid rgba(239,68,68,0.25);}
  .bm{background:rgba(245,158,11,0.15);color:#fbbf24;border:1px solid rgba(245,158,11,0.25);}
  .bl{background:rgba(16,185,129,0.15);color:#34d399;border:1px solid rgba(16,185,129,0.25);}
  .box{padding:40px 24px;text-align:center;}
  .spinner{width:34px;height:34px;border:3px solid #1e2e4a;border-top-color:#00e5ff;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px;}
  .pbar-bg{background:#1e2e4a;border-radius:99px;height:8px;overflow:hidden;max-width:400px;margin:12px auto 0;}
  .pbar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,#00e5ff,#a78bfa);transition:width 0.3s ease;}
  .msg{font-family:'Courier New',monospace;font-size:0.78rem;color:#64748b;margin-top:8px;}
  .err-box{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:10px;padding:16px 20px;margin:0 0 16px;font-family:'Courier New',monospace;font-size:0.78rem;color:#f87171;word-break:break-all;}
  .foot{font-family:'Courier New',monospace;font-size:0.7rem;color:#64748b;text-align:center;padding-top:4px;}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>

<div id="app">
  <div class="hdr">
    <div><h1>Fleet Dashboard</h1><p id="dateRange"></p></div>
    <div class="hdr-right">
      <span class="badge-30">LAST 30 DAYS</span>
      <button class="btn" id="btnRefresh">&#8635; Refresh</button>
    </div>
  </div>
  <div class="kpis">
    <div class="kpi b"><div class="kpi-lbl">Total Fleet Mileage</div><div class="kpi-val" id="k1">—</div><div class="kpi-sub">miles in last 30 days</div></div>
    <div class="kpi o"><div class="kpi-lbl">Total Idle Time</div><div class="kpi-val" id="k2">—</div><div class="kpi-sub">hours across all vehicles</div></div>
    <div class="kpi p"><div class="kpi-lbl">Avg Mileage / Vehicle</div><div class="kpi-val" id="k3">—</div><div class="kpi-sub">miles per vehicle</div></div>
    <div class="kpi g"><div class="kpi-lbl">Vehicles Tracked</div><div class="kpi-val" id="k4">—</div><div class="kpi-sub">active in period</div></div>
  </div>
  <div class="sec-hdr">
    <span class="sec-ttl">Vehicle Breakdown</span>
    <input type="text" class="srch" id="srch" placeholder="Search vehicle..." oninput="fleetDash.filter()"/>
  </div>
  <div id="errBox"></div>
  <div class="tbl-wrap"><div id="tbl"><div class="box"><div class="spinner"></div><div class="msg">WAITING FOR GEOTAB...</div></div></div></div>
  <div class="foot" id="foot"></div>
</div>

<script>
// Wrap everything in a named namespace to avoid touching the global geotab object
var fleetDash = (function() {
  var _api  = null;
  var _rows = [];

  function setDateRange() {
    var now = new Date(), from = new Date(now);
    from.setDate(from.getDate() - 30);
    var fmt = function(d){return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});};
    document.getElementById('dateRange').textContent = fmt(from) + ' \u2192 ' + fmt(now);
  }

  function showErr(msg) {
    document.getElementById('errBox').innerHTML = '<div class="err-box">&#9888; ' + msg + '</div>';
  }
  function clearErr() { document.getElementById('errBox').innerHTML = ''; }

  function showBox(label, pct) {
    document.getElementById('tbl').innerHTML =
      '<div class="box"><div class="spinner"></div>' +
      '<div class="msg">' + label + '</div>' +
      (pct !== undefined ? '<div class="pbar-bg"><div class="pbar-fill" style="width:'+pct+'%"></div></div>' : '') +
      '</div>';
  }

  function resetKPIs() {
    ['k1','k2','k3','k4'].forEach(function(id){document.getElementById(id).textContent='—';});
  }

  function renderKPIs(rows) {
    var tm=rows.reduce(function(s,r){return s+r.miles;},0);
    var ti=rows.reduce(function(s,r){return s+r.idleH;},0);
    document.getElementById('k1').textContent=Math.round(tm).toLocaleString();
    document.getElementById('k2').textContent=ti.toFixed(1)+'h';
    document.getElementById('k3').textContent=rows.length?Math.round(tm/rows.length).toLocaleString():'0';
    document.getElementById('k4').textContent=rows.length;
    document.getElementById('foot').textContent='Last refreshed: '+new Date().toLocaleString();
  }

  function renderTable(rows) {
    if (!rows||!rows.length){showBox('No data found for the last 30 days.');return;}
    var mx=Math.max.apply(null,rows.map(function(r){return r.idleH;}))||1;
    var h='<table><thead><tr>'+
      '<th onclick="fleetDash.sort(\'name\')">Vehicle &#8597;</th>'+
      '<th onclick="fleetDash.sort(\'miles\')">Mileage (mi) &#8597;</th>'+
      '<th onclick="fleetDash.sort(\'idleH\')">Idle Time &#8597;</th>'+
      '<th>Idle Level</th></tr></thead><tbody>';
    rows.forEach(function(r){
      var pct=(r.idleH/mx)*100;
      var lbl=pct>66?'HIGH':pct>33?'MED':'LOW';
      var cls=pct>66?'bh':pct>33?'bm':'bl';
      h+='<tr><td class="vname">'+r.name+'</td>'+
        '<td class="mval">'+Math.round(r.miles).toLocaleString()+'</td>'+
        '<td><div class="ibar-wrap">'+
          '<div class="ibar-bg"><div class="ibar-fill" style="width:'+pct.toFixed(1)+'%"></div></div>'+
          '<span class="ival">'+r.idleH.toFixed(1)+'h</span></div></td>'+
        '<td><span class="bdg '+cls+'">'+lbl+'</span></td></tr>';
    });
    document.getElementById('tbl').innerHTML=h+'</tbody></table>';
  }

  function getFilteredRows() {
    var q=document.getElementById('srch').value.toLowerCase();
    return q?_rows.filter(function(r){return r.name.toLowerCase().indexOf(q)!==-1;}):_rows;
  }

  function fetchData() {
    if (!_api){showBox('API not ready — please refresh.');return;}
    clearErr(); resetKPIs();
    showBox('FETCHING VEHICLES...',5);

    var now=new Date(), from=new Date(now);
    from.setDate(from.getDate()-30);
    var fromStr=from.toISOString(), toStr=now.toISOString();

    _api.call('Get',{typeName:'Device',resultsLimit:1000},
    function(devices){
      if(!devices||!devices.length){showBox('No vehicles found.');return;}
      showBox('FETCHING DATA FOR '+devices.length+' VEHICLES...',20);

      var devMap={};
      devices.forEach(function(d){devMap[d.id]=d.name||d.id;});

      _api.multiCall([
        ['Get',{typeName:'StatusData',search:{diagnosticSearch:{id:'DiagnosticOdometerAdjustmentId'},fromDate:fromStr,toDate:toStr},resultsLimit:100000}],
        ['Get',{typeName:'StatusData',search:{diagnosticSearch:{id:'DiagnosticTotalIdleHoursId'},fromDate:fromStr,toDate:toStr},resultsLimit:100000}]
      ],
      function(res){
        var odomData=(res&&res[0])||[];
        var idleData=(res&&res[1])||[];

        if(odomData.length===0&&idleData.length===0){
          showErr('No diagnostic data found — trying trip-based method instead.');
          fetchViaTrips(devices,devMap,fromStr,toStr);
          return;
        }

        showBox('CALCULATING...',80);

        var odom={},idle={};
        odomData.forEach(function(s){
          var did=s.device&&s.device.id; if(!did)return;
          var v=parseFloat(s.data); if(isNaN(v))return;
          if(!odom[did])odom[did]={mn:v,mx:v};
          if(v<odom[did].mn)odom[did].mn=v;
          if(v>odom[did].mx)odom[did].mx=v;
        });
        idleData.forEach(function(s){
          var did=s.device&&s.device.id; if(!did)return;
          var v=parseFloat(s.data); if(isNaN(v))return;
          if(!idle[did])idle[did]={mn:v,mx:v};
          if(v<idle[did].mn)idle[did].mn=v;
          if(v>idle[did].mx)idle[did].mx=v;
        });

        var seen={};
        Object.keys(odom).forEach(function(k){seen[k]=1;});
        Object.keys(idle).forEach(function(k){seen[k]=1;});

        var rows=[];
        Object.keys(seen).forEach(function(did){
          var miles=odom[did]?Math.max(0,(odom[did].mx-odom[did].mn)/1609.344):0;
          var idleH=idle[did]?Math.max(0,(idle[did].mx-idle[did].mn)):0;
          if(miles===0&&idleH===0)return;
          rows.push({name:devMap[did]||did,miles:miles,idleH:idleH});
        });

        if(!rows.length){
          showErr('Diagnostics returned data but no movement detected — trying trip method.');
          fetchViaTrips(devices,devMap,fromStr,toStr);
          return;
        }

        rows.sort(function(a,b){return b.miles-a.miles;});
        _rows=rows;
        renderKPIs(rows);
        renderTable(rows);
      },
      function(err){
        var msg=err&&err.message?err.message:JSON.stringify(err);
        showErr('Diagnostic query failed ('+msg+') — trying trip fallback.');
        fetchViaTrips(devices,devMap,fromStr,toStr);
      });
    },
    function(err){
      var msg=err&&err.message?err.message:JSON.stringify(err);
      showBox('');
      showErr('Failed to fetch vehicles: '+msg);
    });
  }

  function fetchViaTrips(devices,devMap,fromStr,toStr){
    showBox('FETCHING TRIPS (may take 30–60 sec)...',10);
    var cap=Math.min(devices.length,100);
    var calls=devices.slice(0,cap).map(function(d){
      return ['Get',{typeName:'Trip',search:{deviceSearch:{id:d.id},fromDate:fromStr,toDate:toStr},resultsLimit:2000}];
    });
    _api.multiCall(calls,function(results){
      var rows=[];
      devices.slice(0,cap).forEach(function(d,i){
        var trips=(results&&results[i])||[];
        var miles=0,idleH=0;
        trips.forEach(function(t){
          miles+=(t.distance||0)/1609.344;
          idleH+=(t.idlingDuration||t.stopDuration||0)/3600;
        });
        if(miles===0&&idleH===0)return;
        rows.push({name:devMap[d.id]||d.id,miles:miles,idleH:idleH});
      });
      rows.sort(function(a,b){return b.miles-a.miles;});
      _rows=rows;
      if(!rows.length){showBox('No trip data found for the last 30 days.');return;}
      renderKPIs(rows);
      renderTable(rows);
    },function(err){
      var msg=err&&err.message?err.message:JSON.stringify(err);
      showBox('');
      showErr('Trip fallback also failed: '+msg);
    });
  }

  // Public interface
  return {
    init: function(api) {
      _api = api;
      setDateRange();
      document.getElementById('btnRefresh').onclick = fetchData;
    },
    fetch: fetchData,
    sort: function(k){
      _rows.sort(function(a,b){return typeof a[k]==='string'?a[k].localeCompare(b[k]):b[k]-a[k];});
      renderTable(getFilteredRows());
    },
    filter: function(){ renderTable(getFilteredRows()); }
  };
})();

// ── GEOTAB ENTRY POINT ───────────────────────────────────────────────────────
// Safely extend the existing geotab object — do NOT reassign it
geotab.addin = geotab.addin || {};
geotab.addin.fleetdashboard = function() {
  return {
    initialize: function(api, state, cb) {
      fleetDash.init(api);
      if (typeof cb === 'function') cb();
    },
    focus: function() { fleetDash.fetch(); },
    blur:  function() {}
  };
};
</script>
</body>
</html>
