<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Driver Safety Scorecard</title>
</head>
<body>
<style>
  /* ── DARK MODE (default) ── */
  :root {
    --bg:        #0b0f1a;
    --bg2:       #121929;
    --bg3:       #1a2540;
    --border:    #1e2e4a;
    --text:      #e2e8f0;
    --text2:     #94a3b8;
    --text3:     #64748b;
    --grid-line: rgba(255,107,53,0.02);
    --slider-bg: #1e2e4a;
    --slider-border: #0b0f1a;
    --shadow:    none;
  }
  body.light {
    --bg:        #f1f5f9;
    --bg2:       #ffffff;
    --bg3:       #e2e8f0;
    --border:    #cbd5e1;
    --text:      #0f172a;
    --text2:     #475569;
    --text3:     #64748b;
    --grid-line: rgba(0,0,0,0.04);
    --slider-bg: #cbd5e1;
    --slider-border: #ffffff;
    --shadow:    0 1px 3px rgba(0,0,0,0.08);
  }

  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;min-height:100vh;transition:background 0.3s,color 0.3s;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--grid-line) 1px,transparent 1px),linear-gradient(90deg,var(--grid-line) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
  *{box-sizing:border-box;}
  #app{position:relative;z-index:1;max-width:1380px;margin:0 auto;padding:28px 24px;}

  /* HEADER */
  .hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:16px;}
  h1{font-size:1.8rem;font-weight:800;letter-spacing:-0.03em;background:linear-gradient(90deg,#f59e0b,#ef4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  #dateRange{font-size:0.82rem;color:var(--text3);margin-top:4px;font-family:'Courier New',monospace;}
  .hdr-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}

  .range-group{display:flex;gap:6px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:4px;box-shadow:var(--shadow);}
  .range-btn{background:transparent;border:none;color:var(--text3);padding:6px 14px;border-radius:7px;cursor:pointer;font-family:'Courier New',monospace;font-size:0.72rem;letter-spacing:0.05em;transition:all 0.2s;}
  .range-btn:hover{color:var(--text);}
  .range-btn.active{background:var(--bg3);color:#f59e0b;border:1px solid rgba(245,158,11,0.3);}

  .btn{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:0.82rem;transition:all 0.2s;display:flex;align-items:center;gap:6px;white-space:nowrap;box-shadow:var(--shadow);}
  .btn:hover{border-color:#f59e0b;color:#f59e0b;}
  .btn svg{width:14px;height:14px;flex-shrink:0;}
  .btn.active-btn{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,0.1);}

  /* LIGHT MODE TOGGLE */
  .toggle-wrap{display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);box-shadow:var(--shadow);transition:all 0.2s;}
  .toggle-wrap:hover{border-color:#f59e0b;}
  .toggle-track{width:36px;height:20px;border-radius:99px;background:var(--border);position:relative;transition:background 0.3s;flex-shrink:0;}
  body.light .toggle-track{background:#f59e0b;}
  .toggle-thumb{width:14px;height:14px;border-radius:50%;background:#fff;position:absolute;top:3px;left:3px;transition:transform 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.3);}
  body.light .toggle-thumb{transform:translateX(16px);}
  .toggle-lbl{font-size:0.75rem;font-family:'Courier New',monospace;color:var(--text2);white-space:nowrap;}

  /* KPI CARDS */
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:28px;}
  .kpi{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;position:relative;overflow:hidden;box-shadow:var(--shadow);transition:background 0.3s,border-color 0.2s,transform 0.15s;}
  .kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
  .kpi.amber::before{background:#f59e0b;}.kpi.red::before{background:#ef4444;}.kpi.green::before{background:#10b981;}.kpi.blue::before{background:#00e5ff;}.kpi.purple::before{background:#a78bfa;}.kpi.orange::before{background:#ff6b35;}
  .kpi-lbl{font-size:0.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:0.1em;font-family:'Courier New',monospace;margin-bottom:8px;}
  .kpi-val{font-size:1.8rem;font-weight:800;line-height:1;}
  .kpi.amber .kpi-val{color:#f59e0b;}.kpi.red .kpi-val{color:#ef4444;}.kpi.green .kpi-val{color:#10b981;}.kpi.blue .kpi-val{color:#00e5ff;}.kpi.purple .kpi-val{color:#a78bfa;}.kpi.orange .kpi-val{color:#ff6b35;}
  .kpi-sub{font-size:0.75rem;color:var(--text3);margin-top:5px;}

  /* CLICKABLE KPI */
  .kpi.clickable{cursor:pointer;}
  .kpi.clickable:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.15);}
  .kpi.clickable .kpi-hint{font-size:0.65rem;color:var(--text3);margin-top:8px;font-family:'Courier New',monospace;opacity:0.7;}
  .kpi.clickable:hover .kpi-hint{opacity:1;}
  .kpi.kpi-active{transform:translateY(-2px);}
  .kpi.green.kpi-active{border-color:#10b981;box-shadow:0 0 0 2px rgba(16,185,129,0.2);}
  .kpi.red.kpi-active{border-color:#ef4444;box-shadow:0 0 0 2px rgba(239,68,68,0.2);}

  /* FILTER BADGE */
  .filter-badge{display:inline-flex;align-items:center;gap:8px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 14px;font-family:'Courier New',monospace;font-size:0.75rem;color:var(--text2);margin-bottom:14px;}
  .filter-badge-dot{width:8px;height:8px;border-radius:50%;}
  .filter-badge-x{cursor:pointer;color:var(--text3);font-size:1rem;line-height:1;margin-left:4px;transition:color 0.15s;}
  .filter-badge-x:hover{color:#ef4444;}

  /* SETTINGS PANEL */
  .settings-panel{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:24px;display:none;box-shadow:var(--shadow);}
  .settings-panel.open{display:block;}
  .settings-title{font-size:0.9rem;font-weight:700;margin-bottom:6px;color:var(--text);}
  .settings-desc{font-size:0.78rem;color:var(--text3);margin-bottom:20px;font-family:'Courier New',monospace;}
  .weight-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;}
  .weight-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;}
  .weight-label{font-size:0.72rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.08em;font-family:'Courier New',monospace;margin-bottom:8px;}
  .weight-row{display:flex;align-items:center;gap:10px;}
  .weight-slider{flex:1;-webkit-appearance:none;appearance:none;height:4px;border-radius:99px;background:var(--slider-bg);outline:none;cursor:pointer;}
  .weight-slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#f59e0b;cursor:pointer;border:2px solid var(--slider-border);}
  .weight-val{font-family:'Courier New',monospace;font-size:0.85rem;color:#f59e0b;min-width:28px;text-align:right;font-weight:700;}
  .weight-sub{font-size:0.7rem;color:var(--text3);margin-top:6px;}
  .settings-footer{display:flex;gap:10px;margin-top:20px;justify-content:flex-end;}
  .btn-apply{background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.4);color:#f59e0b;}
  .btn-apply:hover{background:rgba(245,158,11,0.25);}
  .btn-reset-w{background:transparent;border:1px solid var(--border);color:var(--text3);}
  .btn-reset-w:hover{border-color:var(--text2);color:var(--text2);}

  /* TABLE */
  .sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px;}
  .sec-ttl{font-size:1rem;font-weight:700;color:var(--text);}
  .sec-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .srch{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 14px;color:var(--text);font-size:0.875rem;width:200px;outline:none;transition:border-color 0.2s;box-shadow:var(--shadow);}
  .srch:focus{border-color:#f59e0b;}.srch::placeholder{color:var(--text3);}
  .tbl-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:24px;box-shadow:var(--shadow);}
  table{width:100%;border-collapse:collapse;}
  thead tr{background:var(--bg3);border-bottom:1px solid var(--border);}
  th{font-family:'Courier New',monospace;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);padding:12px 16px;text-align:left;cursor:pointer;user-select:none;white-space:nowrap;}
  th:hover{color:#f59e0b;}
  th.sort-asc::after{content:' ↑';color:#f59e0b;}th.sort-desc::after{content:' ↓';color:#f59e0b;}
  tbody tr{border-bottom:1px solid var(--border);transition:background 0.15s;}
  tbody tr:last-child{border-bottom:none;}tbody tr:hover{background:var(--bg3);}
  td{padding:12px 16px;font-size:0.85rem;vertical-align:middle;}
  .dname{font-family:'Courier New',monospace;font-size:0.82rem;font-weight:600;color:var(--text);}

  /* SCORE */
  .score-wrap{display:flex;align-items:center;gap:10px;}
  .score-num{font-family:'Courier New',monospace;font-size:1rem;font-weight:800;min-width:36px;}
  .score-bar-bg{flex:1;height:7px;background:var(--border);border-radius:99px;overflow:hidden;min-width:60px;}
  .score-bar-fill{height:100%;border-radius:99px;}
  .score-hi .score-num{color:#10b981;}.score-hi .score-bar-fill{background:linear-gradient(90deg,#10b981,#34d399);}
  .score-med .score-num{color:#f59e0b;}.score-med .score-bar-fill{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
  .score-low .score-num{color:#ef4444;}.score-low .score-bar-fill{background:linear-gradient(90deg,#ef4444,#f87171);}

  /* EVENT CELLS */
  .ev-cell{display:flex;align-items:center;gap:7px;font-family:'Courier New',monospace;font-size:0.82rem;font-weight:600;}
  .ev-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
  .ev-0{color:#10b981;}.ev-0 .ev-dot{background:#10b981;}
  .ev-few{color:#f59e0b;}.ev-few .ev-dot{background:#f59e0b;}
  .ev-mid{color:#fb923c;}.ev-mid .ev-dot{background:#fb923c;}
  .ev-many{color:#ef4444;}.ev-many .ev-dot{background:#ef4444;}

  /* GRADE */
  .grade{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:8px;font-weight:800;font-size:0.9rem;font-family:'Courier New',monospace;}
  .grade-a{background:rgba(16,185,129,0.15);color:#10b981;border:1px solid rgba(16,185,129,0.35);}
  .grade-b{background:rgba(0,229,255,0.1);color:#00bcd4;border:1px solid rgba(0,188,212,0.3);}
  .grade-c{background:rgba(245,158,11,0.15);color:#d97706;border:1px solid rgba(217,119,6,0.3);}
  .grade-d{background:rgba(255,107,53,0.15);color:#ea580c;border:1px solid rgba(234,88,12,0.3);}
  .grade-f{background:rgba(239,68,68,0.15);color:#dc2626;border:1px solid rgba(220,38,38,0.3);}

  .box{padding:40px 24px;text-align:center;}
  .spinner{width:34px;height:34px;border:3px solid var(--border);border-top-color:#f59e0b;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px;}
  .pbar-bg{background:var(--border);border-radius:99px;height:8px;overflow:hidden;max-width:400px;margin:12px auto 0;}
  .pbar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,#f59e0b,#ef4444);transition:width 0.3s ease;}
  .msg{font-family:'Courier New',monospace;font-size:0.78rem;color:var(--text3);margin-top:8px;}
  .err-box{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:10px;padding:14px 18px;margin:0 0 16px;font-family:'Courier New',monospace;font-size:0.75rem;color:#dc2626;word-break:break-all;}
  .warn-box{background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25);border-radius:10px;padding:12px 16px;margin:0 0 16px;font-family:'Courier New',monospace;font-size:0.73rem;color:#d97706;}
  .foot{font-family:'Courier New',monospace;font-size:0.7rem;color:var(--text3);text-align:center;padding-top:4px;}
  /* TOAST */
  .toast{position:fixed;bottom:28px;right:28px;background:#10b981;color:#fff;font-family:'Courier New',monospace;font-size:0.8rem;padding:12px 20px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:9999;display:flex;align-items:center;gap:8px;transform:translateY(80px);opacity:0;transition:transform 0.3s ease,opacity 0.3s ease;}
  .toast.show{transform:translateY(0);opacity:1;}
  /* SAVED INDICATOR on weight items */
  .weight-item .saved-tag{font-size:0.65rem;color:#10b981;font-family:'Courier New',monospace;margin-top:4px;display:none;}
  .weight-item.is-saved .saved-tag{display:block;}
  .btn-save-def{background:rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.35);color:#10b981;}
  .btn-save-def:hover{background:rgba(16,185,129,0.22);border-color:#10b981;}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>

<div id="app">
  <div class="hdr">
    <div><h1>Driver Safety Scorecard</h1><p id="dateRange"></p></div>
    <div class="hdr-right">
      <div class="range-group">
        <button class="range-btn" onclick="safetyDash.setRange(7)">7D</button>
        <button class="range-btn active" onclick="safetyDash.setRange(30)">30D</button>
        <button class="range-btn" onclick="safetyDash.setRange(60)">60D</button>
        <button class="range-btn" onclick="safetyDash.setRange(90)">90D</button>
      </div>
      <!-- Light mode toggle -->
      <div class="toggle-wrap" onclick="safetyDash.toggleTheme()" title="Toggle light/dark mode">
        <div class="toggle-track"><div class="toggle-thumb"></div></div>
        <span class="toggle-lbl" id="themeLbl">DARK</span>
      </div>
      <button class="btn" id="btnSettings" onclick="safetyDash.toggleSettings()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Weights
      </button>
      <button class="btn" id="btnRefresh">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        Refresh
      </button>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div class="kpis">
    <div class="kpi amber"><div class="kpi-lbl">Fleet Avg Score</div><div class="kpi-val" id="k1">—</div><div class="kpi-sub">out of 100</div></div>
    <div class="kpi green clickable" id="kpi-top" onclick="safetyDash.filterByGroup('top')" title="Click to filter">
      <div class="kpi-lbl">Top Performers</div><div class="kpi-val" id="k2">—</div>
      <div class="kpi-sub">score ≥ 80</div>
      <div class="kpi-hint">&#9654; Click to filter list</div>
    </div>
    <div class="kpi red clickable" id="kpi-risk" onclick="safetyDash.filterByGroup('risk')" title="Click to filter">
      <div class="kpi-lbl">At-Risk Drivers</div><div class="kpi-val" id="k3">—</div>
      <div class="kpi-sub">score &lt; 60</div>
      <div class="kpi-hint">&#9654; Click to filter list</div>
    </div>
    <div class="kpi blue"><div class="kpi-lbl">Total Speeding</div><div class="kpi-val" id="k4">—</div><div class="kpi-sub">events in period</div></div>
    <div class="kpi orange"><div class="kpi-lbl">Hard Braking</div><div class="kpi-val" id="k5">—</div><div class="kpi-sub">events in period</div></div>
    <div class="kpi purple"><div class="kpi-lbl">Drivers Tracked</div><div class="kpi-val" id="k6">—</div><div class="kpi-sub">active in period</div></div>
  </div>

  <!-- SETTINGS PANEL -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-title">&#9881; Score Weight Configuration</div>
    <div class="settings-desc">Adjust how much each behavior affects the score. Higher = bigger penalty per incident. Changes apply when you click Apply.</div>
    <div class="weight-grid">
      <div class="weight-item">
        <div class="weight-label">Speeding</div>
        <div class="weight-row"><input type="range" class="weight-slider" id="w_speeding" min="0" max="40" step="1" value="25" oninput="safetyDash.updateWeightLabel('speeding')"/><span class="weight-val" id="wv_speeding">25</span></div>
        <div class="weight-sub" id="wd_speeding">Max 25 pts &bull; ~3 pts per incident</div>
      </div>
      <div class="weight-item">
        <div class="weight-label">Hard Braking</div>
        <div class="weight-row"><input type="range" class="weight-slider" id="w_braking" min="0" max="40" step="1" value="20" oninput="safetyDash.updateWeightLabel('braking')"/><span class="weight-val" id="wv_braking">20</span></div>
        <div class="weight-sub" id="wd_braking">Max 20 pts &bull; ~4 pts per incident</div>
      </div>
      <div class="weight-item">
        <div class="weight-label">Hard Acceleration</div>
        <div class="weight-row"><input type="range" class="weight-slider" id="w_acceleration" min="0" max="40" step="1" value="20" oninput="safetyDash.updateWeightLabel('acceleration')"/><span class="weight-val" id="wv_acceleration">20</span></div>
        <div class="weight-sub" id="wd_acceleration">Max 20 pts &bull; ~4 pts per incident</div>
      </div>
      <div class="weight-item">
        <div class="weight-label">Harsh Cornering</div>
        <div class="weight-row"><input type="range" class="weight-slider" id="w_cornering" min="0" max="40" step="1" value="20" oninput="safetyDash.updateWeightLabel('cornering')"/><span class="weight-val" id="wv_cornering">20</span></div>
        <div class="weight-sub" id="wd_cornering">Max 20 pts &bull; ~4 pts per incident</div>
      </div>
      <div class="weight-item">
        <div class="weight-label">Seatbelt</div>
        <div class="weight-row"><input type="range" class="weight-slider" id="w_seatbelt" min="0" max="40" step="1" value="15" oninput="safetyDash.updateWeightLabel('seatbelt')"/><span class="weight-val" id="wv_seatbelt">15</span></div>
        <div class="weight-sub" id="wd_seatbelt">Max 15 pts &bull; ~5 pts per incident</div>
      </div>
    </div>
    <div class="settings-footer">
      <button class="btn btn-reset-w" onclick="safetyDash.resetWeights()">Reset to Factory</button>
      <button class="btn btn-save-def" onclick="safetyDash.saveAsDefault()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Save as Default
      </button>
      <button class="btn btn-apply" onclick="safetyDash.applyWeights()">Apply & Recalculate</button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="sec-hdr">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
      <span class="sec-ttl">Driver Scorecard</span>
      <div id="filterBadge" style="display:none;"></div>
    </div>
    <div class="sec-right">
      <input type="text" class="srch" id="srch" placeholder="Search driver..." oninput="safetyDash.filter()"/>
      <button class="btn" onclick="safetyDash.exportCSV()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Export CSV
      </button>
    </div>
  </div>

  <div id="errBox"></div>
  <div id="warnBox"></div>
  <div class="tbl-wrap"><div id="tbl"><div class="box"><div class="spinner"></div><div class="msg">WAITING FOR GEOTAB...</div></div></div></div>
  <div class="foot" id="foot"></div>
</div>
<div class="toast" id="toast"></div>
<div class="toast" id="toast"></div>

<script>
var safetyDash = (function() {
  var _api       = null;
  var _rows      = [];
  var _rawData   = [];
  var _days      = 30;
  var _sortKey   = 'score';
  var _sortDir   = 1;
  var _groupFilter = null; // 'top' | 'risk' | null
  var _isLight   = false;

  var _weights = {
    speeding:     {max:25,perEvent:3},
    braking:      {max:20,perEvent:4},
    acceleration: {max:20,perEvent:4},
    cornering:    {max:20,perEvent:4},
    seatbelt:     {max:15,perEvent:5}
  };

  var RULE_KEYWORDS = {
    speeding:     ['speed'],
    braking:      ['brak'],
    acceleration: ['accel'],
    cornering:    ['corner'],
    seatbelt:     ['seat','belt']
  };

  function setDateRange() {
    var now=new Date(),from=new Date(now);
    from.setDate(from.getDate()-_days);
    var fmt=function(d){return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});};
    document.getElementById('dateRange').textContent=fmt(from)+' \u2192 '+fmt(now);
  }

  function showErr(msg){document.getElementById('errBox').innerHTML='<div class="err-box">&#9888; '+msg+'</div>';}
  function showWarn(msg){document.getElementById('warnBox').innerHTML='<div class="warn-box">&#9432; '+msg+'</div>';}
  function clearMessages(){document.getElementById('errBox').innerHTML='';document.getElementById('warnBox').innerHTML='';}
  function showBox(label,pct){
    document.getElementById('tbl').innerHTML='<div class="box"><div class="spinner"></div><div class="msg">'+label+'</div>'+(pct!==undefined?'<div class="pbar-bg"><div class="pbar-fill" style="width:'+pct+'%"></div></div>':'')+'</div>';
  }
  function resetKPIs(){['k1','k2','k3','k4','k5','k6'].forEach(function(id){document.getElementById(id).textContent='—';});}

  function categorizeRule(ruleName){
    var lower=(ruleName||'').toLowerCase();
    var cats=Object.keys(RULE_KEYWORDS);
    for(var i=0;i<cats.length;i++){
      var kws=RULE_KEYWORDS[cats[i]];
      for(var j=0;j<kws.length;j++){if(lower.indexOf(kws[j])!==-1)return cats[i];}
    }
    return null;
  }

  function calcScore(events,trips){
    if(!trips)return 100;
    var score=100,scale=Math.max(1,trips/10);
    Object.keys(_weights).forEach(function(cat){
      score-=Math.min(_weights[cat].max,((events[cat]||0)/scale)*_weights[cat].perEvent);
    });
    return Math.max(0,Math.round(score));
  }

  function scoreClass(s){return s>=80?'score-hi':s>=60?'score-med':'score-low';}
  function gradeFromScore(s){
    if(s>=90)return{letter:'A',cls:'grade-a'};
    if(s>=80)return{letter:'B',cls:'grade-b'};
    if(s>=70)return{letter:'C',cls:'grade-c'};
    if(s>=60)return{letter:'D',cls:'grade-d'};
    return{letter:'F',cls:'grade-f'};
  }
  function evClass(n){return n===0?'ev-0':n<=5?'ev-few':n<=20?'ev-mid':'ev-many';}

  function renderKPIs(rows){
    var avg=rows.length?Math.round(rows.reduce(function(s,r){return s+r.score;},0)/rows.length):0;
    document.getElementById('k1').textContent=avg;
    document.getElementById('k2').textContent=rows.filter(function(r){return r.score>=80;}).length;
    document.getElementById('k3').textContent=rows.filter(function(r){return r.score<60;}).length;
    document.getElementById('k4').textContent=rows.reduce(function(s,r){return s+(r.events.speeding||0);},0).toLocaleString();
    document.getElementById('k5').textContent=rows.reduce(function(s,r){return s+(r.events.braking||0);},0).toLocaleString();
    document.getElementById('k6').textContent=rows.length;
    document.getElementById('foot').textContent='Last refreshed: '+new Date().toLocaleString()+'  |  Last '+_days+' days  |  Score = 100 minus weighted deductions (normalized by trips)';
  }

  function updateFilterBadge(){
    var badge=document.getElementById('filterBadge');
    var topCard=document.getElementById('kpi-top');
    var riskCard=document.getElementById('kpi-risk');
    topCard.classList.remove('kpi-active');
    riskCard.classList.remove('kpi-active');

    if(!_groupFilter){
      badge.style.display='none';
      return;
    }
    var isTop=_groupFilter==='top';
    var color=isTop?'#10b981':'#ef4444';
    var label=isTop?'Top Performers (score ≥ 80)':'At-Risk Drivers (score < 60)';
    if(isTop) topCard.classList.add('kpi-active');
    else riskCard.classList.add('kpi-active');

    badge.style.display='inline-flex';
    badge.innerHTML='<span class="filter-badge"><span class="filter-badge-dot" style="background:'+color+'"></span>Filtered: '+label+'<span class="filter-badge-x" onclick="safetyDash.clearGroupFilter()" title="Clear filter">&#x2715;</span></span>';
  }

  function getDisplayRows(){
    var rows=_rows;
    // Apply group filter
    if(_groupFilter==='top')   rows=rows.filter(function(r){return r.score>=80;});
    if(_groupFilter==='risk')  rows=rows.filter(function(r){return r.score<60;});
    // Apply search
    var q=document.getElementById('srch').value.toLowerCase();
    if(q) rows=rows.filter(function(r){return r.name.toLowerCase().indexOf(q)!==-1;});
    return rows;
  }

  function renderTable(rows){
    if(!rows||!rows.length){
      var emptyMsg=_groupFilter?'No drivers match this filter.':'No driver data found for the selected period.';
      document.getElementById('tbl').innerHTML='<div class="box"><div class="msg">'+emptyMsg+'</div></div>';
      return;
    }
    function thCls(k){return _sortKey===k?(_sortDir===1?' class="sort-asc"':' class="sort-desc"'):'';}
    var h='<table><thead><tr>'+
      '<th onclick="safetyDash.sort(\'name\')"'+thCls('name')+'>Driver</th>'+
      '<th onclick="safetyDash.sort(\'score\')"'+thCls('score')+'>Score (0–100)</th>'+
      '<th>Grade</th>'+
      '<th onclick="safetyDash.sort(\'trips\')"'+thCls('trips')+'>Trips</th>'+
      '<th onclick="safetyDash.sort(\'speeding\')"'+thCls('speeding')+'>Speeding</th>'+
      '<th onclick="safetyDash.sort(\'braking\')"'+thCls('braking')+'>Hard Braking</th>'+
      '<th onclick="safetyDash.sort(\'acceleration\')"'+thCls('acceleration')+'>Hard Accel</th>'+
      '<th onclick="safetyDash.sort(\'cornering\')"'+thCls('cornering')+'>Cornering</th>'+
      '<th onclick="safetyDash.sort(\'seatbelt\')"'+thCls('seatbelt')+'>Seatbelt</th>'+
      '</tr></thead><tbody>';
    rows.forEach(function(r){
      var sc=scoreClass(r.score),gr=gradeFromScore(r.score);
      function evCell(cat){var n=r.events[cat]||0,cls=evClass(n);return '<td><div class="ev-cell '+cls+'"><span class="ev-dot"></span>'+n+'</div></td>';}
      h+='<tr>'+
        '<td class="dname">'+r.name+'</td>'+
        '<td><div class="score-wrap '+sc+'"><span class="score-num">'+r.score+'</span><div class="score-bar-bg"><div class="score-bar-fill" style="width:'+r.score+'%"></div></div></div></td>'+
        '<td><span class="grade '+gr.cls+'">'+gr.letter+'</span></td>'+
        '<td style="font-family:\'Courier New\',monospace;color:var(--text2);">'+r.trips+'</td>'+
        evCell('speeding')+evCell('braking')+evCell('acceleration')+evCell('cornering')+evCell('seatbelt')+
        '</tr>';
    });
    document.getElementById('tbl').innerHTML=h+'</tbody></table>';
  }

  function buildName(u){
    if(!u)return null;
    var fn=(u.firstName||'').trim(),ln=(u.lastName||'').trim();
    if(fn||ln)return(fn+' '+ln).trim();
    if(u.name&&u.name.trim())return u.name.trim();
    return null;
  }

  function rebuildRows(){
    _rows=_rawData.map(function(d){
      var score=calcScore(d.events,d.trips);
      return{name:d.name,score:score,trips:d.trips,events:d.events,
        speeding:d.events.speeding,braking:d.events.braking,
        acceleration:d.events.acceleration,cornering:d.events.cornering,seatbelt:d.events.seatbelt};
    });
    _rows.sort(function(a,b){return a.score-b.score;});
    _sortKey='score';_sortDir=1;
    renderKPIs(_rows);
    updateFilterBadge();
    renderTable(getDisplayRows());
  }

  function fetchData(){
    if(!_api){showBox('API not ready — please refresh.');return;}
    clearMessages();resetKPIs();_groupFilter=null;updateFilterBadge();
    showBox('FETCHING RULES & USERS...',10);
    var now=new Date(),from=new Date(now);
    from.setDate(from.getDate()-_days);
    var fromStr=from.toISOString(),toStr=now.toISOString();

    _api.multiCall([
      ['Get',{typeName:'Rule',resultsLimit:500}],
      ['Get',{typeName:'User',search:{isDriver:true},resultsLimit:1000}]
    ],function(res){
      var rules=(res&&res[0])||[];
      var users=(res&&res[1])||[];
      var ruleMap={},matchedCats={};
      rules.forEach(function(rule){var cat=categorizeRule(rule.name);if(cat){ruleMap[rule.id]=cat;matchedCats[cat]=true;}});
      var nameMap={};
      users.forEach(function(u){var name=buildName(u);if(name&&u.id)nameMap[u.id]=name;});
      var unmatched=['speeding','braking','acceleration','cornering','seatbelt'].filter(function(c){return !matchedCats[c];});
      if(unmatched.length)showWarn('Rules not found for: '+unmatched.join(', ')+'. These show 0. Your Geotab rule names may differ.');
      fetchEventsAndTrips(ruleMap,nameMap,fromStr,toStr);
    },function(err){
      // Retry without isDriver filter
      _api.call('Get',{typeName:'Rule',resultsLimit:500},function(rules){
        rules=rules||[];
        var ruleMap={};
        rules.forEach(function(rule){var cat=categorizeRule(rule.name);if(cat)ruleMap[rule.id]=cat;});
        fetchEventsAndTrips(ruleMap,{},fromStr,toStr);
      },function(e){showBox('');showErr('Error: '+(e&&e.message?e.message:JSON.stringify(e)));});
    });
  }

  function fetchEventsAndTrips(ruleMap,nameMap,fromStr,toStr){
    showBox('FETCHING EXCEPTIONS & TRIPS...',35);
    _api.multiCall([
      ['Get',{typeName:'ExceptionEvent',search:{fromDate:fromStr,toDate:toStr},resultsLimit:100000}],
      ['Get',{typeName:'Trip',search:{fromDate:fromStr,toDate:toStr},resultsLimit:100000}]
    ],function(res2){
      var exceptions=(res2&&res2[0])||[];
      var trips=(res2&&res2[1])||[];
      showBox('BUILDING SCORECARDS...',80);
      trips.forEach(function(t){var d=t.driver;if(!d||!d.id||d.id==='UnknownDriverId')return;if(!nameMap[d.id]){var name=buildName(d);if(name)nameMap[d.id]=name;}});
      var tripCount={};
      trips.forEach(function(t){var did=t.driver&&t.driver.id;if(!did||did==='UnknownDriverId')return;tripCount[did]=(tripCount[did]||0)+1;});
      var eventsByDriver={};
      exceptions.forEach(function(e){
        var did=e.driver&&e.driver.id;if(!did||did==='UnknownDriverId')return;
        var cat=ruleMap[e.rule&&e.rule.id];if(!cat)return;
        if(!eventsByDriver[did])eventsByDriver[did]={speeding:0,braking:0,acceleration:0,cornering:0,seatbelt:0};
        eventsByDriver[did][cat]++;
        if(!nameMap[did]&&e.driver){var name=buildName(e.driver);if(name)nameMap[did]=name;}
      });
      var seen={};
      Object.keys(tripCount).forEach(function(k){seen[k]=1;});
      Object.keys(eventsByDriver).forEach(function(k){seen[k]=1;});
      _rawData=[];
      Object.keys(seen).forEach(function(did){
        var name=nameMap[did]||('Driver '+did);
        var events=eventsByDriver[did]||{speeding:0,braking:0,acceleration:0,cornering:0,seatbelt:0};
        var tc=tripCount[did]||0;
        _rawData.push({name:name,trips:tc,events:events});
      });
      if(!_rawData.length){showBox('');showErr('No driver data found. Ensure drivers are assigned to vehicles and have trips in this period.');return;}
      rebuildRows();
    },function(err){showBox('');showErr('Error: '+(err&&err.message?err.message:JSON.stringify(err)));});
  }

  return {
    init:function(api){
      _api=api;
      setDateRange();
      document.getElementById('btnRefresh').onclick=fetchData;
      // Restore saved weights from localStorage on every page load
      try{
        var saved=localStorage.getItem('safetyWeights');
        if(saved){
          var parsed=JSON.parse(saved);
          var cats=['speeding','braking','acceleration','cornering','seatbelt'];
          if(cats.every(function(c){return parsed[c]&&typeof parsed[c].max==='number';})){
            cats.forEach(function(cat){
              _weights[cat]={max:parsed[cat].max,perEvent:Math.max(1,Math.round(parsed[cat].max/5))};
              document.getElementById('w_'+cat).value=parsed[cat].max;
              document.getElementById('wv_'+cat).textContent=parsed[cat].max;
              document.getElementById('wd_'+cat).textContent='Max '+parsed[cat].max+' pts \u2022 ~'+Math.max(1,Math.round(parsed[cat].max/5))+' pts per incident';
            });
          }
        }
      }catch(e){}
    },
    fetch:fetchData,

    setRange:function(days){
      _days=days;
      document.querySelectorAll('.range-btn').forEach(function(btn){btn.classList.toggle('active',btn.textContent===days+'D');});
      setDateRange();fetchData();
    },

    toggleTheme:function(){
      _isLight=!_isLight;
      document.body.classList.toggle('light',_isLight);
      document.getElementById('themeLbl').textContent=_isLight?'LIGHT':'DARK';
    },

    toggleSettings:function(){
      var panel=document.getElementById('settingsPanel');
      var btn=document.getElementById('btnSettings');
      var open=panel.classList.toggle('open');
      btn.classList.toggle('active-btn',open);
    },

    filterByGroup:function(group){
      // Toggle off if already active
      if(_groupFilter===group){_groupFilter=null;}
      else{_groupFilter=group;}
      updateFilterBadge();
      renderTable(getDisplayRows());
    },

    clearGroupFilter:function(){
      _groupFilter=null;
      updateFilterBadge();
      renderTable(getDisplayRows());
    },

    updateWeightLabel:function(cat){
      var val=parseInt(document.getElementById('w_'+cat).value,10);
      document.getElementById('wv_'+cat).textContent=val;
      document.getElementById('wd_'+cat).textContent='Max '+val+' pts \u2022 ~'+Math.max(1,Math.round(val/5))+' pts per incident';
    },

    applyWeights:function(){
      ['speeding','braking','acceleration','cornering','seatbelt'].forEach(function(cat){
        var max=parseInt(document.getElementById('w_'+cat).value,10);
        _weights[cat]={max:max,perEvent:Math.max(1,Math.round(max/5))};
      });
      if(_rawData.length)rebuildRows();
      safetyDash._showToast('Scores recalculated','#f59e0b');
    },

    saveAsDefault:function(){
      ['speeding','braking','acceleration','cornering','seatbelt'].forEach(function(cat){
        var max=parseInt(document.getElementById('w_'+cat).value,10);
        _weights[cat]={max:max,perEvent:Math.max(1,Math.round(max/5))};
      });
      try{
        localStorage.setItem('safetyWeights',JSON.stringify(_weights));
        safetyDash._showToast('\u2713 Saved as default \u2014 will load automatically next visit','#10b981');
      }catch(e){
        safetyDash._showToast('Could not save: '+e.message,'#ef4444');
      }
      if(_rawData.length)rebuildRows();
    },

    _showToast:function(msg,color){
      var t=document.getElementById('toast');
      t.style.background=color||'#10b981';
      t.textContent=msg;
      t.classList.add('show');
      setTimeout(function(){t.classList.remove('show');},3000);
    },

    resetWeights:function(){
      // Clear saved weights and restore factory defaults
      try{localStorage.removeItem('safetyWeights');}catch(e){}
      var defs={speeding:{max:25,perEvent:3},braking:{max:20,perEvent:4},acceleration:{max:20,perEvent:4},cornering:{max:20,perEvent:4},seatbelt:{max:15,perEvent:5}};
      Object.keys(defs).forEach(function(cat){
        _weights[cat]=Object.assign({},defs[cat]);
        document.getElementById('w_'+cat).value=defs[cat].max;
        document.getElementById('wv_'+cat).textContent=defs[cat].max;
        document.getElementById('wd_'+cat).textContent='Max '+defs[cat].max+' pts \u2022 '+defs[cat].perEvent+' pts per incident';
      });
      if(_rawData.length)rebuildRows();
      safetyDash._showToast('Reset to factory defaults','#64748b');
    },

    sort:function(k){
      if(_sortKey===k){_sortDir*=-1;}else{_sortKey=k;_sortDir=k==='name'?1:(k==='score'?1:-1);}
      _rows.sort(function(a,b){
        var av=a[k]!==undefined?a[k]:(a.events&&a.events[k])||0;
        var bv=b[k]!==undefined?b[k]:(b.events&&b.events[k])||0;
        if(typeof av==='string')return _sortDir*av.localeCompare(bv);
        return _sortDir*(av-bv);
      });
      renderTable(getDisplayRows());
    },

    filter:function(){renderTable(getDisplayRows());},

    exportCSV:function(){
      if(!_rows.length)return;
      var now=new Date(),from=new Date(now);
      from.setDate(from.getDate()-_days);
      var fmt=function(d){return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});};
      var exportRows=getDisplayRows();
      var filterNote=_groupFilter?(' — Filtered: '+(_groupFilter==='top'?'Top Performers':'At-Risk Drivers')):'';
      var lines=['Driver Safety Scorecard'+filterNote,'Period: '+fmt(from)+' to '+fmt(now),'','Driver,Score,Grade,Trips,Speeding,Hard Braking,Hard Acceleration,Harsh Cornering,Seatbelt'];
      exportRows.forEach(function(r){
        var gr=gradeFromScore(r.score);
        lines.push('"'+r.name.replace(/"/g,'""')+'",'+r.score+','+gr.letter+','+r.trips+','+(r.events.speeding||0)+','+(r.events.braking||0)+','+(r.events.acceleration||0)+','+(r.events.cornering||0)+','+(r.events.seatbelt||0));
      });
      var csv=lines.join('\r\n');
      var blob=new Blob([csv],{type:'text/csv'});
      var url=URL.createObjectURL(blob);
      var a=document.createElement('a');
      a.href=url;a.download='safety-scorecard-'+_days+'d.csv';
      document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
    }
  };
})();

geotab.addin=geotab.addin||{};
geotab.addin.safetyscorecard=function(){
  return{
    initialize:function(api,state,cb){safetyDash.init(api);if(typeof cb==='function')cb();},
    focus:function(){safetyDash.fetch();},
    blur:function(){}
  };
};
</script>
</body>
</html>
