
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Driver Safety Scorecard</title>
</head>
<body>
<style>
  :root{--bg:#0b0f1a;--bg2:#121929;--bg3:#1a2540;--border:#1e2e4a;--text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;--grid:rgba(255,107,53,0.02);--slbg:#1e2e4a;--slbdr:#0b0f1a;--shadow:none;}
  body.light{--bg:#f1f5f9;--bg2:#ffffff;--bg3:#e2e8f0;--border:#cbd5e1;--text:#0f172a;--text2:#475569;--text3:#64748b;--grid:rgba(0,0,0,0.03);--slbg:#cbd5e1;--slbdr:#ffffff;--shadow:0 1px 3px rgba(0,0,0,0.08);}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Arial,sans-serif;min-height:100vh;transition:background .3s,color .3s;}
  body.has-grid{background-image:linear-gradient(var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);background-size:40px 40px;}
  *{box-sizing:border-box;}
  #app{position:relative;z-index:1;max-width:1380px;margin:0 auto;padding:28px 24px;}
  .hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:16px;}
  h1{font-size:1.8rem;font-weight:800;letter-spacing:-.03em;color:#f59e0b;}
  .date-range{font-size:.82rem;color:var(--text3);margin-top:4px;}
  .hdr-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .range-group{display:flex;gap:6px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:4px;box-shadow:var(--shadow);}
  .range-btn{background:transparent;border:none;color:var(--text3);padding:6px 14px;border-radius:7px;cursor:pointer;font-size:.72rem;transition:all .2s;}
  .range-btn:hover{color:var(--text);}
  .range-btn.active{background:var(--bg3);color:#f59e0b;border:1px solid rgba(245,158,11,.3);}
  .btn{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:.82rem;transition:all .2s;display:flex;align-items:center;gap:6px;white-space:nowrap;box-shadow:var(--shadow);}
  .btn:hover{border-color:#f59e0b;color:#f59e0b;}
  .btn svg{width:14px;height:14px;flex-shrink:0;}
  .btn.active-btn{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,.1);}
  .btn-save{background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.35);color:#10b981;}
  .btn-save:hover{background:rgba(16,185,129,.22);border-color:#10b981;}
  .btn-purple{background:rgba(167,139,250,.12);border:1px solid rgba(167,139,250,.35);color:#a78bfa;}
  .btn-purple:hover{background:rgba(167,139,250,.22);border-color:#a78bfa;}
  .btn-apply{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.35);color:#f59e0b;}
  .btn-apply:hover{background:rgba(245,158,11,.22);}
  .toggle-wrap{display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);box-shadow:var(--shadow);transition:all .2s;}
  .toggle-wrap:hover{border-color:#f59e0b;}
  .toggle-track{width:36px;height:20px;border-radius:99px;background:var(--border);position:relative;transition:background .3s;flex-shrink:0;}
  body.light .toggle-track{background:#f59e0b;}
  .toggle-thumb{width:14px;height:14px;border-radius:50%;background:#fff;position:absolute;top:3px;left:3px;transition:transform .3s;box-shadow:0 1px 3px rgba(0,0,0,.3);}
  body.light .toggle-thumb{transform:translateX(16px);}
  .toggle-lbl{font-size:.75rem;color:var(--text2);white-space:nowrap;}
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:28px;}
  .kpi{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;position:relative;overflow:hidden;box-shadow:var(--shadow);transition:background .3s,border-color .2s,transform .15s;}
  .kpi-top-bar{position:absolute;top:0;left:0;right:0;height:2px;}
  .kpi-lbl{font-size:.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;}
  .kpi-val{font-size:1.8rem;font-weight:800;line-height:1;}
  .kpi-sub{font-size:.75rem;color:var(--text3);margin-top:5px;}
  .kpi.clickable{cursor:pointer;}
  .kpi.clickable:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.15);}
  .kpi-hint{font-size:.65rem;color:var(--text3);margin-top:8px;opacity:.7;}
  .kpi.clickable:hover .kpi-hint{opacity:1;}
  .kpi.kpi-active{transform:translateY(-2px);}
  .kpi-active-green{border-color:#10b981;box-shadow:0 0 0 2px rgba(16,185,129,.2);}
  .kpi-active-red{border-color:#ef4444;box-shadow:0 0 0 2px rgba(239,68,68,.2);}
  .filter-badge{display:inline-flex;align-items:center;gap:8px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 14px;font-size:.75rem;color:var(--text2);margin-bottom:14px;}
  .filter-dot{width:8px;height:8px;border-radius:50%;}
  .filter-x{cursor:pointer;color:var(--text3);font-size:1rem;line-height:1;margin-left:4px;transition:color .15s;}
  .filter-x:hover{color:#ef4444;}
  .panel{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:24px;display:none;box-shadow:var(--shadow);}
  .panel.open{display:block;}
  .panel-title{font-size:.9rem;font-weight:700;margin-bottom:6px;color:var(--text);}
  .panel-desc{font-size:.75rem;color:var(--text3);margin-bottom:18px;}
  .panel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;flex-wrap:wrap;gap:8px;}
  .panel-count{font-size:.75rem;color:var(--text3);}
  .panel-footer{display:flex;gap:10px;margin-top:20px;justify-content:flex-end;flex-wrap:wrap;align-items:center;}
  .weight-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;}
  .weight-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;}
  .weight-label{font-size:.72rem;color:var(--text2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .weight-row{display:flex;align-items:center;gap:10px;}
  .weight-slider{flex:1;height:6px;border-radius:99px;background:var(--slbg);outline:none;cursor:pointer;accent-color:#f59e0b;}
  .weight-val{font-size:.85rem;color:#f59e0b;min-width:28px;text-align:right;font-weight:700;}
  .weight-sub{font-size:.7rem;color:var(--text3);margin-top:6px;}
  .weight-empty{padding:16px;font-size:.78rem;color:var(--text3);}
  .rules-cats{display:flex;flex-direction:column;gap:14px;}
  .rule-cat-block{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;}
  .rule-cat-title{font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
  .rule-cat-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
  .rules-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px;}
  .rule-row{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg2);cursor:pointer;transition:border-color .15s;}
  .rule-row:hover{border-color:#f59e0b;}
  .rule-row.rule-on{border-color:rgba(16,185,129,.4);background:rgba(16,185,129,.05);}
  .rule-chk{width:17px;height:17px;border-radius:4px;border:2px solid var(--border);background:transparent;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s;}
  .rule-row.rule-on .rule-chk{background:#10b981;border-color:#10b981;}
  .rule-chk svg{display:none;width:10px;height:10px;}
  .rule-row.rule-on .rule-chk svg{display:block;}
  .rule-info{flex:1;min-width:0;}
  .rule-nm{font-size:.8rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .rule-row.rule-on .rule-nm{color:#10b981;}
  .rule-meta{font-size:.68rem;color:var(--text3);}
  .rule-wt{background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:3px 6px;font-size:.72rem;cursor:pointer;outline:none;}
  .rule-wt:focus{border-color:#f59e0b;}
  .sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px;}
  .sec-ttl{font-size:1rem;font-weight:700;color:var(--text);}
  .sec-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .srch{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 14px;color:var(--text);font-size:.875rem;width:200px;outline:none;transition:border-color .2s;box-shadow:var(--shadow);}
  .srch:focus{border-color:#f59e0b;}
  .tbl-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:24px;box-shadow:var(--shadow);}
  table{width:100%;border-collapse:collapse;table-layout:fixed;}
  thead tr{background:var(--bg3);border-bottom:1px solid var(--border);}
  th{font-size:.68rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);padding:12px 8px;text-align:center;cursor:pointer;user-select:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  th.th-driver{text-align:left;padding-left:16px;width:160px;}
  th.th-score{width:160px;text-align:center;}
  th.th-grade{width:70px;}
  th.th-trips{width:70px;}
  th.th-rule{width:110px;}
  th:hover{color:#f59e0b;}
  th .sort-arrow{color:#f59e0b;font-style:normal;}
  tbody tr{border-bottom:1px solid var(--border);transition:background .15s;}
  tbody tr:last-child{border-bottom:none;}
  tbody tr:hover{background:var(--bg3);}
  td{padding:12px 8px;font-size:.85rem;vertical-align:middle;text-align:center;overflow:hidden;text-overflow:ellipsis;}
  td.td-driver{text-align:left;padding-left:16px;}
  .dname{font-size:.82rem;font-weight:600;color:var(--text);text-align:left;}
  .score-wrap{display:flex;align-items:center;gap:8px;justify-content:center;}
  .score-num{font-size:1rem;font-weight:800;min-width:36px;}
  .score-bar-bg{flex:1;height:7px;background:var(--border);border-radius:99px;overflow:hidden;min-width:60px;}
  .score-bar-fill{height:100%;border-radius:99px;}
  .score-hi .score-num{color:#10b981;}.score-hi .score-bar-fill{background:linear-gradient(90deg,#10b981,#34d399);}
  .score-med .score-num{color:#f59e0b;}.score-med .score-bar-fill{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
  .score-low .score-num{color:#ef4444;}.score-low .score-bar-fill{background:linear-gradient(90deg,#ef4444,#f87171);}
  .ev-cell{display:flex;align-items:center;gap:7px;font-size:.82rem;font-weight:600;justify-content:center;}
  .ev-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
  .ev-0{color:#10b981;}.ev-0 .ev-dot{background:#10b981;}
  .ev-few{color:#f59e0b;}.ev-few .ev-dot{background:#f59e0b;}
  .ev-mid{color:#fb923c;}.ev-mid .ev-dot{background:#fb923c;}
  .ev-many{color:#ef4444;}.ev-many .ev-dot{background:#ef4444;}
  .grade{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:8px;font-weight:800;font-size:.9rem;margin:0 auto;}
  .grade-a{background:rgba(16,185,129,.15);color:#10b981;border:1px solid rgba(16,185,129,.35);}
  .grade-b{background:rgba(0,229,255,.1);color:#00bcd4;border:1px solid rgba(0,188,212,.3);}
  .grade-c{background:rgba(245,158,11,.15);color:#d97706;border:1px solid rgba(217,119,6,.3);}
  .grade-d{background:rgba(255,107,53,.15);color:#ea580c;border:1px solid rgba(234,88,12,.3);}
  .grade-f{background:rgba(239,68,68,.15);color:#dc2626;border:1px solid rgba(220,38,38,.3);}
  .trips-cell{color:var(--text2);text-align:center;}
  .box{padding:40px 24px;text-align:center;}
  .spinner{width:34px;height:34px;border:3px solid var(--border);border-top-color:#f59e0b;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px;}
  .pbar-bg{background:var(--border);border-radius:99px;height:8px;overflow:hidden;max-width:400px;margin:12px auto 0;}
  .pbar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,#f59e0b,#ef4444);transition:width .3s ease;}
  .msg-txt{font-size:.78rem;color:var(--text3);margin-top:8px;}
  .err-box{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:10px;padding:14px 18px;margin:0 0 16px;font-size:.75rem;color:#dc2626;word-break:break-all;}
  .warn-box{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:10px;padding:12px 16px;margin:0 0 16px;font-size:.73rem;color:#d97706;}
  .foot{font-size:.7rem;color:var(--text3);text-align:center;padding-top:4px;}
  .toast{position:fixed;bottom:28px;right:28px;color:#fff;font-size:.8rem;padding:12px 20px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:9999;display:flex;align-items:center;gap:8px;transform:translateY(80px);opacity:0;transition:transform .3s ease,opacity .3s ease;}
  .toast.show{transform:translateY(0);opacity:1;}
  .srch::placeholder{color:var(--text3);}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* WEIGHT TOTAL BAR */
  .wt-total-bar{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:var(--bg);margin-bottom:16px;flex-wrap:wrap;}
  .wt-total-label{font-size:.72rem;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;}
  .wt-total-num{font-size:1.1rem;font-weight:800;min-width:48px;}
  .wt-total-ok{color:#10b981;}.wt-total-over{color:#ef4444;}.wt-total-under{color:#f59e0b;}
  .wt-total-track{flex:1;height:8px;background:var(--border);border-radius:99px;overflow:hidden;min-width:80px;}
  .wt-total-fill{height:100%;border-radius:99px;transition:width .25s,background .25s;}
  .wt-total-hint{font-size:.7rem;color:var(--text3);margin-left:auto;}
  .wt-tooltip{position:relative;display:inline-flex;align-items:center;margin-left:6px;cursor:help;}
  .wt-tooltip-icon{width:16px;height:16px;border-radius:50%;border:1px solid var(--text3);color:var(--text3);font-size:.65rem;font-weight:700;display:flex;align-items:center;justify-content:center;line-height:1;transition:all .15s;}
  .wt-tooltip:hover .wt-tooltip-icon{border-color:#f59e0b;color:#f59e0b;}
  .wt-tooltip-popup{display:none;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:.72rem;color:var(--text2);width:240px;z-index:200;line-height:1.5;box-shadow:0 4px 16px rgba(0,0,0,.25);}
  .wt-tooltip:hover .wt-tooltip-popup{display:block;}

  /* WEIGHT ITEMS - percentage style */
  .weight-pct{font-size:1rem;font-weight:800;color:#f59e0b;min-width:44px;text-align:right;}
  .weight-input-wrap{display:flex;align-items:center;gap:6px;}
  .weight-pct-input{width:58px;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:5px 8px;font-size:.85rem;font-weight:700;text-align:center;outline:none;transition:border-color .2s;}
  .weight-pct-input:focus{border-color:#f59e0b;}
  .weight-pct-input.input-err{border-color:#ef4444;}
  .weight-eq-btn{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);color:#f59e0b;border-radius:6px;padding:5px 10px;font-size:.72rem;cursor:pointer;transition:all .15s;white-space:nowrap;}
  .weight-eq-btn:hover{background:rgba(245,158,11,.2);}

  /* INFO MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:500;display:none;align-items:center;justify-content:center;padding:24px;}
  .modal-overlay.open{display:flex;}
  .modal{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:560px;width:100%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.4);}
  .modal-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
  .modal-title{font-size:1rem;font-weight:800;color:var(--text);}
  .modal-close{cursor:pointer;color:var(--text3);font-size:1.3rem;line-height:1;transition:color .15s;}
  .modal-close:hover{color:#ef4444;}
  .modal-section{margin-bottom:18px;}
  .modal-section-title{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#f59e0b;margin-bottom:8px;}
  .modal-body{font-size:.82rem;color:var(--text2);line-height:1.65;}
  .modal-formula{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 16px;font-size:.8rem;color:var(--text2);margin:10px 0;line-height:1.7;}
  .modal-formula strong{color:var(--text);}
  .modal-grade-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:8px;}
  .modal-grade-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:8px;}
  .modal-grade-item .grade{margin:0;}
  .modal-grade-range{font-size:.68rem;color:var(--text3);}

  /* SCHEDULE PANEL */
  .sched-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px;}
  .sched-field label{display:block;font-size:.7rem;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;}
  .sched-sel,.sched-input{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:7px;padding:9px 12px;font-size:.82rem;outline:none;transition:border-color .2s;}
  .sched-sel:focus,.sched-input:focus{border-color:#f59e0b;}
  .sched-emails-wrap label{display:block;font-size:.7rem;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;}
  .sched-chips{display:flex;flex-wrap:wrap;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:8px 10px;min-height:42px;cursor:text;transition:border-color .2s;}
  .sched-chips:focus-within{border-color:#f59e0b;}
  .schip{display:inline-flex;align-items:center;gap:5px;background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.3);border-radius:99px;padding:3px 10px;font-size:.75rem;color:#f59e0b;}
  .schip-x{cursor:pointer;opacity:.6;font-size:1rem;line-height:1;}
  .schip-x:hover{opacity:1;}
  .schip-input{border:none;background:transparent;color:var(--text);font-size:.82rem;outline:none;flex:1;min-width:160px;padding:2px 4px;}
  .sched-status{font-size:.75rem;padding:10px 14px;border-radius:8px;margin-top:12px;display:none;}
  .sched-status.on{display:block;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:#10b981;}
  .sched-status.off{display:block;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);color:#d97706;}
</style>

<div id="app">
  <div class="hdr">
    <div>
      <h1>Driver Safety Scorecard</h1>
      <p class="date-range" id="dateRange"></p>
    </div>
    <div class="hdr-right">
      <div class="range-group">
        <button class="range-btn" onclick="safetyDash.setRange(7)">7D</button>
        <button class="range-btn active" onclick="safetyDash.setRange(30)">30D</button>
        <button class="range-btn" onclick="safetyDash.setRange(60)">60D</button>
        <button class="range-btn" onclick="safetyDash.setRange(90)">90D</button>
      </div>
      <div class="toggle-wrap" onclick="safetyDash.toggleTheme()">
        <div class="toggle-track"><div class="toggle-thumb"></div></div>
        <span class="toggle-lbl" id="themeLbl">DARK</span>
      </div>
      <button class="btn" id="btnInfo" onclick="safetyDash.toggleInfo()" title="How scoring works">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        How It Works
      </button>
      <button class="btn" id="btnSchedule" onclick="safetyDash.togglePanel('schedule')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Schedule Report
      </button>
      <button class="btn" id="btnWeights" onclick="safetyDash.togglePanel('weights')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Weights
      </button>
      <button class="btn btn-purple" id="btnRules" onclick="safetyDash.togglePanel('rules')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Rules
      </button>
      <button class="btn" id="btnRefresh">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        Refresh
      </button>
    </div>
  </div>

  <div class="kpis">
    <div class="kpi" id="kpi-avg">
      <div class="kpi-top-bar" style="background:#f59e0b;"></div>
      <div class="kpi-lbl">Fleet Avg Score</div><div class="kpi-val" id="k1" style="color:#f59e0b;">&#8212;</div><div class="kpi-sub">out of 100</div>
    </div>
    <div class="kpi clickable" id="kpi-top" onclick="safetyDash.filterGroup('top')">
      <div class="kpi-top-bar" style="background:#10b981;"></div>
      <div class="kpi-lbl">Top Performers</div><div class="kpi-val" id="k2" style="color:#10b981;">&#8212;</div>
      <div class="kpi-sub">score &#8805; 80</div><div class="kpi-hint">&#9654; Click to filter</div>
    </div>
    <div class="kpi clickable" id="kpi-risk" onclick="safetyDash.filterGroup('risk')">
      <div class="kpi-top-bar" style="background:#ef4444;"></div>
      <div class="kpi-lbl">At-Risk Drivers</div><div class="kpi-val" id="k3" style="color:#ef4444;">&#8212;</div>
      <div class="kpi-sub">score &lt; 60</div><div class="kpi-hint">&#9654; Click to filter</div>
    </div>
    <div class="kpi" id="kpi-spd">
      <div class="kpi-top-bar" style="background:#00e5ff;"></div>
      <div class="kpi-lbl">Total Speeding</div><div class="kpi-val" id="k4" style="color:#00e5ff;">&#8212;</div><div class="kpi-sub">events in period</div>
    </div>
    <div class="kpi" id="kpi-brk">
      <div class="kpi-top-bar" style="background:#ff6b35;"></div>
      <div class="kpi-lbl">Hard Braking</div><div class="kpi-val" id="k5" style="color:#ff6b35;">&#8212;</div><div class="kpi-sub">events in period</div>
    </div>
    <div class="kpi" id="kpi-drv">
      <div class="kpi-top-bar" style="background:#a78bfa;"></div>
      <div class="kpi-lbl">Drivers Tracked</div><div class="kpi-val" id="k6" style="color:#a78bfa;">&#8212;</div><div class="kpi-sub">active in period</div>
    </div>
  </div>

  <!-- WEIGHTS PANEL -->
  <div class="panel" id="panelWeights">
    <div class="panel-header">
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="panel-title">&#9881; Score Weight Configuration</div>
        <div class="wt-tooltip">
          <div class="wt-tooltip-icon">?</div>
          <div class="wt-tooltip-popup">Weights must total exactly 100. Each rule's weight is its share of the total score penalty. Equal distribution is set automatically when rules are added or removed. You can override individual values - the remaining weight is redistributed automatically.</div>
        </div>
      </div>
      <span class="panel-count" id="weightsCount"></span>
    </div>
    <div class="panel-desc">Each weight is a percentage of the total score (must sum to 100). Higher weight = bigger impact on the score. Rules are auto-equalized when added or removed.</div>
    <div class="wt-total-bar">
      <span class="wt-total-label">Total Weight</span>
      <span class="wt-total-num" id="wtTotalNum">100</span>
      <div class="wt-total-track"><div class="wt-total-fill" id="wtTotalFill" style="width:100%;background:#10b981;"></div></div>
      <span class="wt-total-hint" id="wtTotalHint">&#10003; Balanced</span>
      <button class="weight-eq-btn" onclick="safetyDash.equalizeWeights()">&#8776; Auto-equalize</button>
    </div>
    <div class="weight-grid" id="weightGrid"><div class="weight-empty">Load data first to see weights.</div></div>
    <div class="panel-footer">
      <button class="btn" onclick="safetyDash.resetWeights()">Reset to Factory</button>
      <button class="btn btn-save" onclick="safetyDash.saveWeights()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Save as Default
      </button>
      <button class="btn btn-apply" onclick="safetyDash.applyWeights()">Apply &amp; Recalculate</button>
    </div>
  </div>

  <!-- RULES PANEL -->
  <div class="panel" id="panelRules">
    <div class="panel-header">
      <div class="panel-title">&#10003; Rule Configuration</div>
      <span class="panel-count" id="ruleCount"></span>
    </div>
    <div class="panel-desc">Toggle which exception rules affect driver scores. Each rule has its own penalty weight per incident. Custom rules appear under Uncategorized.</div>
    <div id="rulesList"><div class="box"><div class="msg-txt">Load data first to see available rules.</div></div></div>
    <div class="panel-footer">
      <span class="panel-count" id="rulesEnabled"></span>
      <button class="btn" onclick="safetyDash.resetRules()" style="margin-left:auto;">Reset Rules</button>
      <button class="btn btn-save" onclick="safetyDash.saveRulesDefault()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Save as Default
      </button>
      <button class="btn btn-apply" onclick="safetyDash.saveRules()">Apply &amp; Recalculate</button>
    </div>
  </div>

  <!-- SCHEDULE PANEL -->
  <div class="panel" id="panelSchedule">
    <div class="panel-header">
      <div class="panel-title">&#128197; Schedule Email Report</div>
      <span class="panel-count" id="schedCount"></span>
    </div>
    <div class="panel-desc">Automatically email the Driver Safety Scorecard as a CSV report on a recurring schedule.</div>
    <div class="sched-grid">
      <div class="sched-field">
        <label>Frequency</label>
        <select class="sched-sel" id="schedFreq" onchange="safetyDash.schedFreqChange()">
          <option value="daily">Daily</option>
          <option value="weekly" selected>Weekly</option>
          <option value="biweekly">Every 2 Weeks</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>
      <div class="sched-field" id="schedDayField">
        <label>Day of Week</label>
        <select class="sched-sel" id="schedDay">
          <option value="1">Monday</option>
          <option value="2">Tuesday</option>
          <option value="3">Wednesday</option>
          <option value="4">Thursday</option>
          <option value="5" selected>Friday</option>
          <option value="6">Saturday</option>
          <option value="0">Sunday</option>
        </select>
      </div>
      <div class="sched-field">
        <label>Start Date</label>
        <input type="date" class="sched-input" id="schedStart"/>
      </div>
      <div class="sched-field">
        <label>Report Time</label>
        <select class="sched-sel" id="schedTime">
          <option value="06:00">6:00 AM</option>
          <option value="07:00">7:00 AM</option>
          <option value="08:00" selected>8:00 AM</option>
          <option value="09:00">9:00 AM</option>
          <option value="12:00">12:00 PM</option>
          <option value="17:00">5:00 PM</option>
        </select>
      </div>
    </div>
    <div class="sched-emails-wrap" style="margin-bottom:16px;">
      <label>Recipients</label>
      <div class="sched-chips" id="schedChips" onclick="document.getElementById('schedChipInput').focus()">
        <input class="schip-input" id="schedChipInput" placeholder="Add email, press Enter..." onkeydown="safetyDash.schedChipKey(event)"/>
      </div>
    </div>
    <div class="sched-field" style="margin-bottom:16px;">
      <label>Report Subject Line</label>
      <input type="text" class="sched-input" id="schedSubject" value="Driver Safety Scorecard Report" placeholder="Email subject..."/>
    </div>
    <div class="sched-status" id="schedStatus"></div>
    <div class="panel-footer">
      <button class="btn" onclick="safetyDash.togglePanel('schedule')">Cancel</button>
      <button class="btn" id="btnSchedDisable" onclick="safetyDash.disableSchedule()" style="display:none;">Disable Schedule</button>
      <button class="btn btn-save" onclick="safetyDash.saveSchedule()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Save Schedule
      </button>
    </div>
  </div>

  <!-- INFO MODAL -->
  <div class="modal-overlay" id="infoModal" onclick="if(event.target===this)safetyDash.toggleInfo()">
    <div class="modal">
      <div class="modal-hdr">
        <span class="modal-title">&#9432; How Driver Scoring Works</span>
        <span class="modal-close" onclick="safetyDash.toggleInfo()">&#x2715;</span>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Score Formula</div>
        <div class="modal-body">Every driver starts with a perfect score of 100. Points are deducted for each safety rule violation, scaled by how many trips the driver made in the period.</div>
        <div class="modal-formula">
          <strong>Score = 100 &minus; &sum; Rule Deductions</strong><br/>
          <strong>Rule Deduction</strong> = min( Weight, (Events &divide; Scale) &times; Points/Incident )<br/>
          <strong>Scale</strong> = max(1, Trips &divide; 10)
        </div>
        <div class="modal-body">The trip scaling prevents drivers with fewer trips from being unfairly penalized. A driver with 5 trips is held to a proportionally lower bar than one with 100 trips.</div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Weights</div>
        <div class="modal-body">Each enabled rule has a <strong>Weight</strong> (0&ndash;100) representing its share of the total score impact. All weights must sum to exactly 100. When rules are added or removed, weights are automatically equalized. You can manually override any weight &mdash; the others are redistributed proportionally to maintain the 100-point total.</div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Points Per Incident</div>
        <div class="modal-body">Set in the Rules panel per rule. This controls how many raw penalty points each event generates before the weight cap is applied. Higher = more sensitive to individual incidents.</div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Grade Scale</div>
        <div class="modal-grade-grid">
          <div class="modal-grade-item"><span class="grade grade-a">A</span><span class="modal-grade-range">90&ndash;100</span></div>
          <div class="modal-grade-item"><span class="grade grade-b">B</span><span class="modal-grade-range">80&ndash;89</span></div>
          <div class="modal-grade-item"><span class="grade grade-c">C</span><span class="modal-grade-range">70&ndash;79</span></div>
          <div class="modal-grade-item"><span class="grade grade-d">D</span><span class="modal-grade-range">60&ndash;69</span></div>
          <div class="modal-grade-item"><span class="grade grade-f">F</span><span class="modal-grade-range">0&ndash;59</span></div>
        </div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Tips</div>
        <div class="modal-body">
          &bull; Use the <strong>Rules</strong> panel to toggle which violations count and set sensitivity.<br/>
          &bull; Use <strong>Weights</strong> to prioritize the violations that matter most to your fleet.<br/>
          &bull; Click <strong>Top Performers</strong> or <strong>At-Risk Drivers</strong> KPI cards to filter the table.<br/>
          &bull; Use <strong>Schedule Report</strong> to automatically email a CSV scorecard on a recurring basis.
        </div>
      </div>
    </div>
  </div>

  <div class="sec-hdr">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
      <span class="sec-ttl">Driver Scorecard</span>
      <div id="filterBadge" style="display:none;"></div>
    </div>
    <div class="sec-right">
      <input type="text" class="srch" id="srch" placeholder="Search driver..." oninput="safetyDash.filter()"/>
      <button class="btn" onclick="safetyDash.exportCSV()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Export CSV
      </button>
    </div>
  </div>

  <div id="errBox"></div>
  <div id="warnBox"></div>
  <div class="tbl-wrap"><div id="tbl"><div class="box"><div class="spinner"></div><div class="msg-txt">WAITING FOR GEOTAB...</div></div></div></div>
  <div class="foot" id="foot"></div>
</div>
<div class="toast" id="toast"></div>

<script>
var safetyDash = (function() {
  var _api = null, _rows = [], _rawData = [], _allRules = [], _ruleConfig = {}, _ruleWeights = {};
  var _days = 30, _sortKey = 'score', _sortDir = 1, _groupFilter = null, _isLight = false;
  var _schedEmails = [], _schedEnabled = false;
  var SCHED_KEY = 'safetySchedule';

  var CATS = ['speeding','braking','acceleration','cornering','seatbelt','other'];
  var CAT_LABELS = {speeding:'Speeding',braking:'Hard Braking',acceleration:'Hard Acceleration',cornering:'Harsh Cornering',seatbelt:'Seatbelt',other:'Uncategorized / Custom'};
  var CAT_COLORS = {speeding:'#ef4444',braking:'#f59e0b',acceleration:'#fb923c',cornering:'#a78bfa',seatbelt:'#00e5ff',other:'#64748b'};
  var KEYWORDS = {speeding:['speed'],braking:['brak'],acceleration:['accel'],cornering:['corner'],seatbelt:['seat','belt']};

  function setDateRange() {
    var now = new Date(), from = new Date(now);
    from.setDate(from.getDate() - _days);
    var fmt = function(d){return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});};
    document.getElementById('dateRange').textContent = fmt(from) + ' to ' + fmt(now);
  }
  function showErr(m){document.getElementById('errBox').innerHTML='<div class="err-box">&#9888; '+m+'</div>';}
  function clearMsg(){document.getElementById('errBox').innerHTML='';document.getElementById('warnBox').innerHTML='';}
  function showBox(label,pct){
    document.getElementById('tbl').innerHTML='<div class="box"><div class="spinner"></div><div class="msg-txt">'+label+'</div>'+(pct!==undefined?'<div class="pbar-bg"><div class="pbar-fill" style="width:'+pct+'%"></div></div>':'')+'</div>';
  }
  function resetKPIs(){['k1','k2','k3','k4','k5','k6'].forEach(function(id){document.getElementById(id).textContent='-';});}
  function toast(msg,color){
    var t=document.getElementById('toast');
    t.style.background=color||'#10b981';
    t.textContent=msg;
    t.classList.add('show');
    setTimeout(function(){t.classList.remove('show');},3000);
  }
  function guessCategory(ruleName){
    var lo=(ruleName||'').toLowerCase();
    var ks=Object.keys(KEYWORDS);
    for(var i=0;i<ks.length;i++){
      var kws=KEYWORDS[ks[i]];
      for(var j=0;j<kws.length;j++){if(lo.indexOf(kws[j])!==-1)return ks[i];}
    }
    return 'other';
  }
  function buildDriverName(u){
    if(!u) return null;
    var fn=(u.firstName||'').trim(), ln=(u.lastName||'').trim();
    if(fn||ln) return (fn+' '+ln).trim();
    if(u.name&&u.name.trim()) return u.name.trim();
    return null;
  }
  function scoreClass(s){return s>=80?'score-hi':s>=60?'score-med':'score-low';}
  function gradeFromScore(s){
    if(s>=90)return{l:'A',c:'grade-a'};if(s>=80)return{l:'B',c:'grade-b'};
    if(s>=70)return{l:'C',c:'grade-c'};if(s>=60)return{l:'D',c:'grade-d'};
    return{l:'F',c:'grade-f'};
  }
  function evClass(n){return n===0?'ev-0':n<=5?'ev-few':n<=20?'ev-mid':'ev-many';}

  // \u2500\u2500 WEIGHT SYSTEM: percentages summing to 100 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
  function getEnabledRules(){
    return Object.keys(_ruleConfig).filter(function(rid){return _ruleConfig[rid]&&_ruleConfig[rid].enabled;});
  }

  function getWeight(rid){
    return (_ruleWeights[rid]!==undefined) ? _ruleWeights[rid] : 0;
  }

  function getTotalWeight(){
    return getEnabledRules().reduce(function(s,rid){return s+getWeight(rid);},0);
  }

  // Set all enabled rules to equal share summing to 100
  // Map sid (sanitized id) back to rid (real rule id)
  function _sidToRid(sid){
    var enabled=getEnabledRules();
    for(var i=0;i<enabled.length;i++){
      if(enabled[i].replace(/[^a-zA-Z0-9]/g,'_')===sid) return enabled[i];
    }
    return null;
  }

  function equalizeWeightsData(){
    var enabled=getEnabledRules();
    if(!enabled.length) return;
    var base=Math.floor(100/enabled.length);
    var rem=100-(base*enabled.length);
    enabled.forEach(function(rid,i){ _ruleWeights[rid]=base+(i<rem?1:0); });
  }

  // After user edits one rule's weight, redistribute remainder proportionally
  function redistributeAfterEdit(changedRid, newVal){
    var enabled=getEnabledRules();
    if(enabled.length<=1){ _ruleWeights[changedRid]=100; return; }
    newVal=Math.max(0,Math.min(100,newVal));
    _ruleWeights[changedRid]=newVal;
    var rest=enabled.filter(function(r){return r!==changedRid;});
    var remaining=100-newVal;
    if(remaining<0) remaining=0;
    var oldOthersTotal=rest.reduce(function(s,r){return s+getWeight(r);},0);
    if(oldOthersTotal===0){
      // distribute evenly
      var share=Math.floor(remaining/rest.length), extra=remaining-(share*rest.length);
      rest.forEach(function(r,i){_ruleWeights[r]=share+(i<extra?1:0);});
    } else {
      // distribute proportionally
      var assigned=0;
      rest.forEach(function(r,i){
        if(i===rest.length-1){ _ruleWeights[r]=remaining-assigned; }
        else {
          var prop=Math.round((getWeight(r)/oldOthersTotal)*remaining);
          _ruleWeights[r]=Math.max(0,prop);
          assigned+=_ruleWeights[r];
        }
      });
    }
    // Final correction for rounding
    var total=getTotalWeight();
    if(total!==100){
      var diff=100-total;
      // give the diff to the first rule that can absorb it
      for(var i=0;i<rest.length;i++){
        if(_ruleWeights[rest[i]]+diff>=0){ _ruleWeights[rest[i]]+=diff; break; }
      }
    }
  }

  function calcScore(ebr, trips){
    if(!trips) return 100;
    var enabled=getEnabledRules();
    if(!enabled.length) return 100;
    var scale=Math.max(1,trips/10);
    var totalDeduction=0;
    enabled.forEach(function(rid){
      var cnt=ebr[rid]||0;
      var wt=getWeight(rid);          // percentage weight 0-100
      var perEvent=(_ruleConfig[rid]&&_ruleConfig[rid].perEvent)||3;
      // Raw events scaled by trips, capped at the rule's weight allocation
      var raw=(cnt/scale)*perEvent;
      totalDeduction+=Math.min(wt, raw);
    });
    return Math.max(0,Math.round(100-totalDeduction));
  }

  function initRuleConfig(rules){
    var savedCfg=null, savedWts=null;
    try{var s=localStorage.getItem('safetyRuleConfig');if(s)savedCfg=JSON.parse(s);}catch(e){}
    try{var rw=localStorage.getItem('safetyRuleWeights');if(rw)savedWts=JSON.parse(rw);}catch(e){}
    _allRules=rules;
    _ruleConfig={};
    rules.forEach(function(rule){
      var cat=guessCategory(rule.name);
      if(savedCfg&&savedCfg[rule.id]){
        _ruleConfig[rule.id]={enabled:!!savedCfg[rule.id].enabled,category:savedCfg[rule.id].category||cat,perEvent:savedCfg[rule.id].perEvent||3};
      } else {
        _ruleConfig[rule.id]={enabled:cat!=='other',category:cat,perEvent:3};
      }
    });
    // Load or initialize weights
    if(savedWts){
      _ruleWeights=savedWts;
      // Validate: if enabled rules changed, re-equalize
      var enabled=getEnabledRules();
      var savedTotal=enabled.reduce(function(s,r){return s+(savedWts[r]||0);},0);
      if(Math.abs(savedTotal-100)>2) equalizeWeightsData();
    } else {
      _ruleWeights={};
      equalizeWeightsData();
    }
  }

  function rebuildRows(){
    _rows=_rawData.map(function(d){
      var score=calcScore(d.ebr,d.trips);
      var row={dname:d.dname,score:score,trips:d.trips,ebr:d.ebr};
      CATS.forEach(function(cat){
        row['cat_'+cat]=Object.keys(_ruleConfig).filter(function(rid){return _ruleConfig[rid].enabled&&_ruleConfig[rid].category===cat;}).reduce(function(s,rid){return s+(d.ebr[rid]||0);},0);
      });
      Object.keys(d.ebr).forEach(function(rid){row['rule_'+rid]=d.ebr[rid];});
      return row;
    });
    _rows.sort(function(a,b){return a.score-b.score;});
    _sortKey='score'; _sortDir=1;
    renderKPIs(_rows);
    updateBadge();
    renderTable(getDisplayRows());
    renderRulesPanel();
    renderWeightsPanel();
  }

  function renderKPIs(rows){
    var avg=rows.length?Math.round(rows.reduce(function(s,r){return s+r.score;},0)/rows.length):0;
    var spd=0,brk=0;
    rows.forEach(function(r){
      Object.keys(_ruleConfig).forEach(function(rid){
        var cfg=_ruleConfig[rid]; if(!cfg.enabled) return;
        if(cfg.category==='speeding') spd+=(r.ebr[rid]||0);
        if(cfg.category==='braking')  brk+=(r.ebr[rid]||0);
      });
    });
    document.getElementById('k1').textContent=avg;
    document.getElementById('k2').textContent=rows.filter(function(r){return r.score>=80;}).length;
    document.getElementById('k3').textContent=rows.filter(function(r){return r.score<60;}).length;
    document.getElementById('k4').textContent=spd.toLocaleString();
    document.getElementById('k5').textContent=brk.toLocaleString();
    document.getElementById('k6').textContent=rows.length;
    document.getElementById('foot').textContent='Last refreshed: '+new Date().toLocaleString()+'  |  Last '+_days+' days  |  Score = 100 minus weighted deductions (normalized by trips)';
  }

  function updateBadge(){
    var badge=document.getElementById('filterBadge');
    var topCard=document.getElementById('kpi-top');
    var riskCard=document.getElementById('kpi-risk');
    topCard.classList.remove('kpi-active','kpi-active-green');
    riskCard.classList.remove('kpi-active','kpi-active-red');
    if(!_groupFilter){badge.style.display='none';return;}
    var isTop=_groupFilter==='top';
    var color=isTop?'#10b981':'#ef4444';
    var label=isTop?'Top Performers (score 80+)':'At-Risk Drivers (score below 60)';
    if(isTop){topCard.classList.add('kpi-active','kpi-active-green');}
    else{riskCard.classList.add('kpi-active','kpi-active-red');}
    badge.style.display='inline-flex';
    badge.innerHTML='<span class="filter-badge"><span class="filter-dot" style="background:'+color+'"></span>Filtered: '+label+'<span class="filter-x" onclick="safetyDash.clearFilter()">&#x2715;</span></span>';
  }

  function getDisplayRows(){
    var rows=_rows;
    if(_groupFilter==='top') rows=rows.filter(function(r){return r.score>=80;});
    if(_groupFilter==='risk') rows=rows.filter(function(r){return r.score<60;});
    var q=document.getElementById('srch').value.toLowerCase();
    if(q) rows=rows.filter(function(r){return r.dname.toLowerCase().indexOf(q)!==-1;});
    return rows;
  }

  function renderTable(rows){
    if(!rows||!rows.length){
      document.getElementById('tbl').innerHTML='<div class="box"><div class="msg-txt">'+(_groupFilter?'No drivers match this filter.':'No driver data found.')+'</div></div>';
      return;
    }
    var enabled=Object.keys(_ruleConfig).filter(function(rid){return _ruleConfig[rid]&&_ruleConfig[rid].enabled;});
    var useCat=enabled.length>8;
    var colCats=CATS.filter(function(c){return enabled.some(function(rid){return _ruleConfig[rid].category===c;});});

    function thSort(k, label, cls){
      var arrow='';
      if(_sortKey===k) arrow=' <em class="sort-arrow">'+ (_sortDir===1?'&#9650;':'&#9660;') +'</em>';
      var c=cls?' class="'+cls+'"':'';
      return '<th'+c+' onclick="safetyDash.sort(\''+k+'\')">'+label+arrow+'</th>';
    }

    var h='<table><thead><tr>'+
      thSort('dname','Driver','th-driver')+
      thSort('score','Score','th-score')+
      '<th class="th-grade">Grade</th>'+
      thSort('trips','Trips','th-trips');

    if(useCat){
      colCats.forEach(function(cat){h+=thSort('cat_'+cat,CAT_LABELS[cat],'th-rule');});
    } else {
      enabled.forEach(function(rid){
        var rule=null;
        for(var i=0;i<_allRules.length;i++){if(_allRules[i].id===rid){rule=_allRules[i];break;}}
        var nm=rule?rule.name:rid;
        var short=nm.length>18?nm.substring(0,16)+'..':nm;
        h+=thSort('rule_'+rid,short,'th-rule');
      });
    }
    h+='</tr></thead><tbody>';

    rows.forEach(function(r){
      var sc=scoreClass(r.score), gr=gradeFromScore(r.score);
      h+='<tr><td class="dname td-driver">'+r.dname+'</td>'+
        '<td><div class="score-wrap '+sc+'"><span class="score-num">'+r.score+'</span>'+
        '<div class="score-bar-bg"><div class="score-bar-fill" style="width:'+r.score+'%"></div></div></div></td>'+
        '<td><span class="grade '+gr.c+'">'+gr.l+'</span></td>'+
        '<td class="trips-cell">'+r.trips+'</td>';
      if(useCat){
        colCats.forEach(function(cat){
          var total=enabled.filter(function(rid){return _ruleConfig[rid].category===cat;}).reduce(function(s,rid){return s+(r.ebr[rid]||0);},0);
          h+='<td><div class="ev-cell '+evClass(total)+'"><span class="ev-dot"></span>'+total+'</div></td>';
        });
      } else {
        enabled.forEach(function(rid){
          var n=r.ebr[rid]||0;
          h+='<td><div class="ev-cell '+evClass(n)+'"><span class="ev-dot"></span>'+n+'</div></td>';
        });
      }
      h+='</tr>';
    });
    document.getElementById('tbl').innerHTML=h+'</tbody></table>';
  }

  function updateWeightTotalBar(){
    var total=getTotalWeight();
    var numEl=document.getElementById('wtTotalNum');
    var fillEl=document.getElementById('wtTotalFill');
    var hintEl=document.getElementById('wtTotalHint');
    if(!numEl) return;
    numEl.textContent=total;
    numEl.className='wt-total-num '+(total===100?'wt-total-ok':total>100?'wt-total-over':'wt-total-under');
    fillEl.style.width=Math.min(100,total)+'%';
    fillEl.style.background=total===100?'#10b981':total>100?'#ef4444':'#f59e0b';
    hintEl.textContent=total===100?'\u2713 Balanced':total>100?'\u26A0 Over by '+(total-100)+'%':'\u26A0 Under by '+(100-total)+'%';
    hintEl.style.color=total===100?'#10b981':total>100?'#ef4444':'#f59e0b';
  }

  function syncWeightUI(rid,sid,newVal){
    var slEl=document.getElementById('wsl_'+sid);
    var piEl=document.getElementById('wpi_'+sid);
    var sbEl=document.getElementById('wsb_'+sid);
    var perE=(_ruleConfig[rid]&&_ruleConfig[rid].perEvent)||3;
    if(slEl) slEl.value=newVal;
    if(piEl){piEl.value=newVal; piEl.classList.toggle('input-err',newVal<0||newVal>100);}
    if(sbEl) sbEl.textContent=newVal+'% weight \u2022 '+perE+' pts/incident';
    getEnabledRules().forEach(function(r){
      if(r===rid) return;
      var s2=r.replace(/[^a-zA-Z0-9]/g,'_'),v=getWeight(r),pe2=(_ruleConfig[r]&&_ruleConfig[r].perEvent)||3;
      var sl2=document.getElementById('wsl_'+s2),pi2=document.getElementById('wpi_'+s2),sb2=document.getElementById('wsb_'+s2);
      if(sl2) sl2.value=v;
      if(pi2) pi2.value=v;
      if(sb2) sb2.textContent=v+'% weight \u2022 '+pe2+' pts/incident';
    });
    updateWeightTotalBar();
  }

  function renderWeightsPanel(){
    var enabled=getEnabledRules();
    var wc=document.getElementById('weightsCount');
    if(wc) wc.textContent=enabled.length+' rule'+(enabled.length===1?'':'s');
    updateWeightTotalBar();
    var grid=document.getElementById('weightGrid');
    if(!grid) return;
    if(!enabled.length){grid.innerHTML='<div class="weight-empty">No rules enabled. Enable rules in the Rules panel first.</div>';return;}
    var h='';
    enabled.forEach(function(rid){
      var rule=null;
      for(var i=0;i<_allRules.length;i++){if(_allRules[i].id===rid){rule=_allRules[i];break;}}
      var rname=rule?rule.name:rid, wt=getWeight(rid), perE=(_ruleConfig[rid]&&_ruleConfig[rid].perEvent)||3;
      var sid=rid.replace(/[^a-zA-Z0-9]/g,'_');
      h+='<div class="weight-item">'+
        '<div class="weight-label" title="'+rname+'">'+rname+'</div>'+
        '<div class="weight-input-wrap">'+
          '<input type="range" class="weight-slider" id="wsl_'+sid+'" data-rid="'+sid+'" min="0" max="100" step="1" value="'+wt+'" oninput="safetyDash.onWeightSlide(this)"/>'+
          '<input type="number" class="weight-pct-input" id="wpi_'+sid+'" data-rid="'+sid+'" min="0" max="100" value="'+wt+'" oninput="safetyDash.onWeightInput(this)"/>'+
          '<span style="font-size:.75rem;color:var(--text3);">%</span>'+
        '</div>'+
        '<div class="weight-sub" id="wsb_'+sid+'">'+wt+'% weight - '+perE+' pts/incident</div>'+
      '</div>';
    });
    grid.innerHTML=h;
  }

  function renderRulesPanel(){
    if(!_allRules.length) return;
    var enabledCount=Object.keys(_ruleConfig).filter(function(rid){return _ruleConfig[rid]&&_ruleConfig[rid].enabled;}).length;
    document.getElementById('ruleCount').textContent=_allRules.length+' rules available';
    document.getElementById('rulesEnabled').textContent=enabledCount+' rules enabled';
    var bycat={};
    CATS.forEach(function(c){bycat[c]=[];});
    _allRules.forEach(function(rule){
      var cat=_ruleConfig[rule.id]?_ruleConfig[rule.id].category:guessCategory(rule.name);
      if(!bycat[cat]) bycat[cat]=[];
      bycat[cat].push(rule);
    });
    var h='<div class="rules-cats">';
    CATS.forEach(function(cat){
      var rules=bycat[cat]||[];
      if(!rules.length) return;
      h+='<div class="rule-cat-block">'+
        '<div class="rule-cat-title"><span class="rule-cat-dot" style="background:'+CAT_COLORS[cat]+'"></span>'+CAT_LABELS[cat]+' ('+rules.length+')</div>'+
        '<div class="rules-grid">';
      rules.forEach(function(rule){
        var cfg=_ruleConfig[rule.id]||{enabled:false,category:cat,perEvent:3};
        var on=cfg.enabled;
        var ptOpts=[1,2,3,4,5,7,10].map(function(v){return '<option value="'+v+'"'+(cfg.perEvent===v?' selected':'')+'>'+v+'pt</option>';}).join('');
        h+='<div class="rule-row'+(on?' rule-on':'')+'" id="rr_'+rule.id+'" onclick="safetyDash.toggleRule(\''+rule.id+'\')">'+
          '<div class="rule-chk"><svg viewBox="0 0 12 10" fill="none" stroke="#fff" stroke-width="2.5"><polyline points="1,5 4.5,8.5 11,1"/></svg></div>'+
          '<div class="rule-info">'+
            '<div class="rule-nm" title="'+rule.name+'">'+rule.name+'</div>'+
            '<div class="rule-meta">'+CAT_LABELS[cat]+'</div>'+
          '</div>'+
          '<select class="rule-wt" onclick="event.stopPropagation()" onchange="safetyDash.setRuleWt(\''+rule.id+'\',this.value)">'+ptOpts+'</select>'+
        '</div>';
      });
      h+='</div></div>';
    });
    h+='</div>';
    document.getElementById('rulesList').innerHTML=h;
  }

  function fetchData(){
    if(!_api){showBox('API not ready.');return;}
    clearMsg(); resetKPIs(); _groupFilter=null; updateBadge();
    showBox('FETCHING RULES...',5);
    var now=new Date(), from=new Date(now);
    from.setDate(from.getDate()-_days);
    var fromStr=from.toISOString(), toStr=now.toISOString();

    _api.multiCall([
      ['Get',{typeName:'Rule',resultsLimit:1000}],
      ['Get',{typeName:'User',search:{isDriver:true},resultsLimit:1000}]
    ],function(res){
      var rules=(res&&res[0])||[];
      var users=(res&&res[1])||[];
      initRuleConfig(rules);
      var dmap={};
      users.forEach(function(u){var dn=buildDriverName(u);if(dn&&u.id)dmap[u.id]=dn;});
      doFetch(dmap,fromStr,toStr);
    },function(){
      _api.call('Get',{typeName:'Rule',resultsLimit:1000},function(rules){
        initRuleConfig(rules||[]);
        doFetch({},fromStr,toStr);
      },function(e){showBox('');showErr('Error: '+(e&&e.message?e.message:JSON.stringify(e)));});
    });
  }

  function doFetch(dmap,fromStr,toStr){
    showBox('FETCHING EXCEPTIONS & TRIPS...',30);
    _api.multiCall([
      ['Get',{typeName:'ExceptionEvent',search:{fromDate:fromStr,toDate:toStr},resultsLimit:100000}],
      ['Get',{typeName:'Trip',search:{fromDate:fromStr,toDate:toStr},resultsLimit:100000}]
    ],function(res){
      var excs=(res&&res[0])||[];
      var trips=(res&&res[1])||[];
      showBox('BUILDING SCORECARDS...',80);
      trips.forEach(function(t){
        var d=t.driver; if(!d||!d.id||d.id==='UnknownDriverId') return;
        if(!dmap[d.id]){var dn=buildDriverName(d);if(dn)dmap[d.id]=dn;}
      });
      var tc={};
      trips.forEach(function(t){
        var did=t.driver&&t.driver.id; if(!did||did==='UnknownDriverId') return;
        tc[did]=(tc[did]||0)+1;
      });
      var ebrd={};
      excs.forEach(function(e){
        var did=e.driver&&e.driver.id; if(!did||did==='UnknownDriverId') return;
        var rid=e.rule&&e.rule.id; if(!rid) return;
        if(!ebrd[did]) ebrd[did]={};
        ebrd[did][rid]=(ebrd[did][rid]||0)+1;
        if(!dmap[did]&&e.driver){var dn=buildDriverName(e.driver);if(dn)dmap[did]=dn;}
      });
      var seen={};
      Object.keys(tc).forEach(function(k){seen[k]=1;});
      Object.keys(ebrd).forEach(function(k){seen[k]=1;});
      _rawData=[];
      Object.keys(seen).forEach(function(did){
        _rawData.push({dname:dmap[did]||('Driver '+did),trips:tc[did]||0,ebr:ebrd[did]||{}});
      });
      if(!_rawData.length){showBox('');showErr('No driver data found.');return;}
      rebuildRows();
    },function(err){showBox('');showErr('Error: '+(err&&err.message?err.message:JSON.stringify(err)));});
  }

  // \u2500\u2500 SCHEDULE \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
  function loadSchedule(){
    try{
      var s=localStorage.getItem(SCHED_KEY);
      if(!s) return;
      var d=JSON.parse(s);
      _schedEmails=d.emails||[];
      _schedEnabled=d.enabled||false;
      if(d.freq) document.getElementById('schedFreq').value=d.freq;
      if(d.day!==undefined) document.getElementById('schedDay').value=d.day;
      if(d.time) document.getElementById('schedTime').value=d.time;
      if(d.start) document.getElementById('schedStart').value=d.start;
      if(d.subject) document.getElementById('schedSubject').value=d.subject;
      _schedEmails.forEach(function(e){ addSchedChipEl(e); });
      updateSchedStatus();
    }catch(e){}
  }

  function saveScheduleData(){
    try{
      localStorage.setItem(SCHED_KEY, JSON.stringify({
        emails: _schedEmails,
        enabled: _schedEnabled,
        freq: document.getElementById('schedFreq').value,
        day: document.getElementById('schedDay').value,
        time: document.getElementById('schedTime').value,
        start: document.getElementById('schedStart').value,
        subject: document.getElementById('schedSubject').value
      }));
    }catch(e){}
  }

  function updateSchedStatus(){
    var el=document.getElementById('schedStatus');
    var disBtn=document.getElementById('btnSchedDisable');
    if(!el) return;
    if(_schedEnabled && _schedEmails.length){
      var freq=document.getElementById('schedFreq');
      var freqTxt=freq?freq.options[freq.selectedIndex].text:'Weekly';
      el.className='sched-status on';
      el.textContent='\u2713 Active \u2014 report sends '+freqTxt.toLowerCase()+' to '+_schedEmails.length+' recipient'+ (_schedEmails.length>1?'s':'');
      if(disBtn) disBtn.style.display='';
    } else {
      el.className='sched-status off';
      el.textContent='Schedule is inactive. Add recipients and save to activate.';
      if(disBtn) disBtn.style.display='none';
    }
  }

  function addSchedChipEl(email){
    var wrap=document.getElementById('schedChips');
    var input=document.getElementById('schedChipInput');
    var chip=document.createElement('span');
    chip.className='schip';
    chip.setAttribute('data-email',email);
    chip.innerHTML=email+'<span class="schip-x" onclick="safetyDash.removeSchedChip(this)">\u2715</span>';
    wrap.insertBefore(chip,input);
  }

  function checkAndSendScheduled(){
    if(!_schedEnabled||!_schedEmails.length||!_rows.length) return;
    try{
      var saved=JSON.parse(localStorage.getItem(SCHED_KEY)||'{}');
      var lastSent=saved.lastSent?new Date(saved.lastSent):null;
      var now=new Date();
      var shouldSend=false;
      if(!lastSent){ shouldSend=true; }
      else {
        var freq=saved.freq||'weekly';
        var diff=(now-lastSent)/86400000;
        if(freq==='daily'&&diff>=1) shouldSend=true;
        else if(freq==='weekly'&&diff>=7) shouldSend=true;
        else if(freq==='biweekly'&&diff>=14) shouldSend=true;
        else if(freq==='monthly'&&diff>=28) shouldSend=true;
      }
      if(shouldSend){
        sendScheduledEmail();
        saved.lastSent=now.toISOString();
        localStorage.setItem(SCHED_KEY,JSON.stringify(saved));
      }
    }catch(e){}
  }

  function sendScheduledEmail(){
    var subject=document.getElementById('schedSubject').value||'Driver Safety Scorecard Report';
    var now=new Date();
    var fmt=function(d){return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});};
    var from=new Date(now); from.setDate(from.getDate()-_days);
    var sep='\n';
    var enabled=getEnabledRules();
    var ruleNames=enabled.map(function(rid){
      for(var i=0;i<_allRules.length;i++){if(_allRules[i].id===rid)return _allRules[i].name;}
      return rid;
    });
    var csvLines=[
      'Driver Safety Scorecard Report',
      'Period: '+fmt(from)+' to '+fmt(now),
      'Generated: '+now.toLocaleString(),
      '',
      'Driver,Score,Grade,Trips,'+ruleNames.join(',')
    ];
    _rows.forEach(function(r){
      var gr=gradeFromScore(r.score);
      csvLines.push('"'+r.dname.replace(/"/g,'""')+'",'+r.score+','+gr.l+','+r.trips+','+enabled.map(function(rid){return r.ebr[rid]||0;}).join(','));
    });
    var body=csvLines.join(sep);
    var fullMsg=subject+sep+sep+body;
    if(_api){
      _schedEmails.forEach(function(email){
        try{
          _api.call('Add',{typeName:'TextMessage',entity:{
            message:fullMsg,
            isDirectionToVehicle:false,
            messageContent:{contentType:'Normal',message:fullMsg}
          }},function(){},function(){});
        }catch(e){}
      });
    }
    toast('Scheduled report sent to '+_schedEmails.length+' recipient'+(_schedEmails.length>1?'s':''),'#10b981');
  }
  function checkAndSendScheduled(){
    if(!_schedEnabled||!_schedEmails.length||!_rows.length) return;
    try{
      var saved=JSON.parse(localStorage.getItem(SCHED_KEY)||'{}');
      var lastSent=saved.lastSent?new Date(saved.lastSent):null;
      var now=new Date();
      var shouldSend=false;
      if(!lastSent){ shouldSend=true; }
      else {
        var freq=saved.freq||'weekly';
        var diff=(now-lastSent)/86400000;
        if(freq==='daily'&&diff>=1) shouldSend=true;
        else if(freq==='weekly'&&diff>=7) shouldSend=true;
        else if(freq==='biweekly'&&diff>=14) shouldSend=true;
        else if(freq==='monthly'&&diff>=28) shouldSend=true;
      }
      if(shouldSend){
        sendScheduledEmail();
        saved.lastSent=now.toISOString();
        localStorage.setItem(SCHED_KEY,JSON.stringify(saved));
      }
    }catch(e){}
  }

  function onRuleToggled(){
    equalizeWeightsData();
    if(document.getElementById('panelWeights').classList.contains('open')) renderWeightsPanel();
  }

  return {
    init: function(api){
      _api=api; setDateRange();
      document.getElementById('btnRefresh').onclick=fetchData;
      var today=new Date().toISOString().split('T')[0];
      document.getElementById('schedStart').value=today;
      loadSchedule();
      setTimeout(function(){ if(_rows.length) checkAndSendScheduled(); }, 5000);
    },
    fetch: fetchData,

    setRange: function(days){
      _days=days;
      document.querySelectorAll('.range-btn').forEach(function(b){b.classList.toggle('active',b.textContent===days+'D');});
      setDateRange(); fetchData();
    },

    toggleTheme: function(){
      _isLight=!_isLight;
      document.body.classList.toggle('light',_isLight);
      document.getElementById('themeLbl').textContent=_isLight?'LIGHT':'DARK';
    },

    toggleInfo: function(){
      document.getElementById('infoModal').classList.toggle('open');
    },

    togglePanel: function(which){
      var ids={weights:'panelWeights',rules:'panelRules',schedule:'panelSchedule'};
      var btns={weights:'btnWeights',rules:'btnRules',schedule:'btnSchedule'};
      Object.keys(ids).forEach(function(k){
        if(k===which){
          var isOpen=document.getElementById(ids[k]).classList.toggle('open');
          if(btns[k]&&document.getElementById(btns[k])) document.getElementById(btns[k]).classList.toggle('active-btn',isOpen);
          if(isOpen&&k==='rules'&&_allRules.length) renderRulesPanel();
          if(isOpen&&k==='weights') renderWeightsPanel();
          if(isOpen&&k==='schedule') updateSchedStatus();
        } else {
          document.getElementById(ids[k]).classList.remove('open');
          if(btns[k]&&document.getElementById(btns[k])) document.getElementById(btns[k]).classList.remove('active-btn');
        }
      });
    },

    toggleRule: function(rid){
      if(!_ruleConfig[rid]) return;
      _ruleConfig[rid].enabled=!_ruleConfig[rid].enabled;
      var row=document.getElementById('rr_'+rid);
      if(row) row.classList.toggle('rule-on',_ruleConfig[rid].enabled);
      var cnt=getEnabledRules().length;
      var el=document.getElementById('rulesEnabled');
      if(el) el.textContent=cnt+' rules enabled';
      onRuleToggled();
    },

    setRuleWt: function(rid,val){
      if(_ruleConfig[rid]) _ruleConfig[rid].perEvent=parseInt(val,10)||1;
    },

    saveRulesDefault: function(){
      try{
        localStorage.setItem('safetyRuleConfig',JSON.stringify(_ruleConfig));
        toast('Rule config saved as default','#10b981');
      }catch(e){toast('Could not save: '+e.message,'#ef4444');}
    },

    saveRules: function(){
      try{localStorage.setItem('safetyRuleConfig',JSON.stringify(_ruleConfig));}catch(e){}
      if(_rawData.length) rebuildRows();
      toast('Rules applied - scores recalculated','#f59e0b');
    },

    resetRules: function(){
      try{localStorage.removeItem('safetyRuleConfig');}catch(e){}
      if(_allRules.length){initRuleConfig(_allRules);renderRulesPanel();}
      if(_rawData.length) rebuildRows();
      toast('Rules reset to defaults','#64748b');
    },

    filterGroup: function(g){
      _groupFilter=(_groupFilter===g)?null:g;
      updateBadge(); renderTable(getDisplayRows());
    },
    clearFilter: function(){_groupFilter=null;updateBadge();renderTable(getDisplayRows());},

    onWeightSlide: function(el){
      var sid=el.getAttribute('data-rid');
      var rid=_sidToRid(sid);
      if(!rid) return;
      var v=parseInt(el.value,10);
      redistributeAfterEdit(rid,v);
      syncWeightUI(rid,sid,getWeight(rid));
    },

    onWeightInput: function(el){
      var sid=el.getAttribute('data-rid');
      var rid=_sidToRid(sid);
      if(!rid) return;
      var v=parseInt(el.value,10);
      if(isNaN(v)) return;
      redistributeAfterEdit(rid,v);
      syncWeightUI(rid,sid,getWeight(rid));
    },

    equalizeWeights: function(){
      equalizeWeightsData();
      renderWeightsPanel();
      var n=Math.max(1,getEnabledRules().length);
      toast('Weights equalized to '+Math.round(100/n)+'% each','#f59e0b');
    },

    applyWeights: function(){
      var total=getTotalWeight();
      if(total!==100){ equalizeWeightsData(); renderWeightsPanel(); }
      if(_rawData.length) rebuildRows();
      toast('Scores recalculated with new weights','#f59e0b');
    },

    saveWeights: function(){
      var total=getTotalWeight();
      if(total!==100){ equalizeWeightsData(); renderWeightsPanel(); }
      try{
        localStorage.setItem('safetyRuleWeights',JSON.stringify(_ruleWeights));
        toast('Weights saved (total: '+getTotalWeight()+'%)','#10b981');
      }catch(e){toast('Could not save: '+e.message,'#ef4444');}
      if(_rawData.length) rebuildRows();
    },

    resetWeights: function(){
      try{localStorage.removeItem('safetyRuleWeights');}catch(e){}
      _ruleWeights={};
      equalizeWeightsData();
      renderWeightsPanel();
      if(_rawData.length) rebuildRows();
      toast('Reset to equal distribution','#64748b');
    },

    sort: function(k){
      if(_sortKey===k){_sortDir*=-1;}else{_sortKey=k;_sortDir=(k==='dname'||k==='score')?1:-1;}
      _rows.sort(function(a,b){
        var av=a[k]!==undefined?a[k]:0, bv=b[k]!==undefined?b[k]:0;
        if(typeof av==='string') return _sortDir*av.localeCompare(bv);
        return _sortDir*(av-bv);
      });
      renderTable(getDisplayRows());
    },

    filter: function(){renderTable(getDisplayRows());},

    schedFreqChange: function(){
      var freq=document.getElementById('schedFreq').value;
      var dayField=document.getElementById('schedDayField');
      if(dayField) dayField.style.display=(freq==='daily')?'none':'';
    },

    schedChipKey: function(e){
      if(e.key==='Enter'||e.key===','){
        e.preventDefault();
        var val=document.getElementById('schedChipInput').value.trim().replace(/,$/,'');
        if(val&&val.indexOf('@')!==-1&&_schedEmails.indexOf(val)===-1){
          _schedEmails.push(val);
          addSchedChipEl(val);
          document.getElementById('schedChipInput').value='';
        }
      }
      if(e.key==='Backspace'&&!document.getElementById('schedChipInput').value&&_schedEmails.length){
        var chips=document.getElementById('schedChips').querySelectorAll('.schip');
        if(chips.length){
          var last=chips[chips.length-1];
          var email=last.getAttribute('data-email');
          _schedEmails=_schedEmails.filter(function(x){return x!==email;});
          last.remove();
        }
      }
    },

    removeSchedChip: function(xEl){
      var chip=xEl.parentElement;
      var email=chip.getAttribute('data-email');
      _schedEmails=_schedEmails.filter(function(x){return x!==email;});
      chip.remove();
    },

    saveSchedule: function(){
      if(!_schedEmails.length){
        toast('Add at least one recipient email first','#ef4444'); return;
      }
      _schedEnabled=true;
      saveScheduleData();
      updateSchedStatus();
      toast('Schedule saved - report will send '+document.getElementById('schedFreq').value,'#10b981');
    },

    disableSchedule: function(){
      _schedEnabled=false;
      saveScheduleData();
      updateSchedStatus();
      toast('Schedule disabled','#64748b');
    },

    exportCSV: function(){
      if(!_rows.length) return;
      var now=new Date(), from=new Date(now);
      from.setDate(from.getDate()-_days);
      var fmt=function(d){return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});};
      var exportRows=getDisplayRows();
      var enabled=getEnabledRules();
      var ruleNames=enabled.map(function(rid){
        for(var i=0;i<_allRules.length;i++){if(_allRules[i].id===rid)return _allRules[i].name;}
        return rid;
      });
      var note=_groupFilter?(' - '+(_groupFilter==='top'?'Top Performers':'At-Risk')):'';
      var lines=['Driver Safety Scorecard'+note,'Period: '+fmt(from)+' to '+fmt(now),'','Driver,Score,Grade,Trips,'+ruleNames.join(',')];
      exportRows.forEach(function(r){
        var gr=gradeFromScore(r.score);
        lines.push('"'+r.dname.replace(/"/g,'""')+'",'+r.score+','+gr.l+','+r.trips+','+enabled.map(function(rid){return r.ebr[rid]||0;}).join(','));
      });
      var csv=lines.join('\r\n');
      var blob=new Blob([csv],{type:'text/csv'});
      var url=URL.createObjectURL(blob);
      var a=document.createElement('a');
      a.href=url; a.download='safety-scorecard-'+_days+'d.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }
  };
})();

geotab.addin = geotab.addin || {};
geotab.addin.safetyscorecard = function() {
  return {
    initialize: function(api,state,cb){safetyDash.init(api);if(typeof cb==='function')cb();},
    focus:      function(){safetyDash.fetch();},
    blur:       function(){}
  };
};
</script>
</body>
</html>
